package com.hhplus.ecommerce.integration;

import com.hhplus.ecommerce.application.product.ProductService;
import com.hhplus.ecommerce.domain.product.Product;
import com.hhplus.ecommerce.domain.product.ProductOption;
import com.hhplus.ecommerce.domain.product.ProductRepository;
import com.hhplus.ecommerce.presentation.product.response.ProductDetailResponse;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.cache.CacheManager;
import org.springframework.data.redis.core.RedisTemplate;

import java.time.LocalDateTime;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”´ Redis ìºì‹œ TTL ê²€ì¦ í…ŒìŠ¤íŠ¸
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ëª©ì :
 * - ìºì‹œì˜ TTL(Time-To-Live)ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ ê²€ì¦
 * - ê° ìºì‹œë³„ë¡œ ë‹¤ë¥¸ TTLì´ ì ì ˆíˆ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
 * - Redisì—ì„œ ìºì‹œê°€ ìë™ìœ¼ë¡œ ë§Œë£Œë˜ëŠ”ì§€ ê²€ì¦
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“‹ ê²€ì¦ í•­ëª©
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * ìºì‹œë³„ TTL ì„¤ì • (CacheConfig.java):
 * - productList:      1ì‹œê°„ (3600ì´ˆ)
 * - productDetail:    2ì‹œê°„ (7200ì´ˆ)
 * - couponList:       30ë¶„ (1800ì´ˆ)
 * - cartItems:        30ë¶„ (1800ì´ˆ)
 * - popularProducts:  1ì‹œê°„ (3600ì´ˆ)
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * Test 1: testProductDetail_TTL_Verification()
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Given:   ìƒí’ˆ ìƒì„¸ ì¡°íšŒë¡œ Redis ìºì‹œ ì €ì¥ (TTL: 2ì‹œê°„)
 * When:    RedisTemplateìœ¼ë¡œ TTLì„ ì¡°íšŒ
 * Then:    TTLì´ 2ì‹œê°„(7200ì´ˆ) ë²”ìœ„ ë‚´ì— ì„¤ì •ë˜ì—ˆëŠ”ê°€?
 *
 * Expected: TTL >= 7190ì´ˆ && TTL <= 7200ì´ˆ
 * (10ì´ˆ ì˜¤ì°¨ë²”ìœ„: ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ ê³ ë ¤)
 *
 * Test 2: testProductList_TTL_Verification()
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * Given:   ìƒí’ˆ ëª©ë¡ ì¡°íšŒë¡œ Redis ìºì‹œ ì €ì¥ (TTL: 1ì‹œê°„)
 * When:    RedisTemplateìœ¼ë¡œ TTLì„ ì¡°íšŒ
 * Then:    TTLì´ 1ì‹œê°„(3600ì´ˆ) ë²”ìœ„ ë‚´ì— ì„¤ì •ë˜ì—ˆëŠ”ê°€?
 *
 * Expected: TTL >= 3590ì´ˆ && TTL <= 3600ì´ˆ
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ’¡ Redis TTL ê²€ì¦ ë°©ë²•
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * Redisì—ì„œ TTLì„ í™•ì¸í•˜ë ¤ë©´ EXPIRE ì»¤ë§¨ë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:
 *
 * ```bash
 * # Redis CLIì—ì„œ ì§ì ‘ í™•ì¸
 * redis-cli
 * > TTL cache:productDetail::1
 * (integer) 7195
 *
 * # Spring RedisTemplateìœ¼ë¡œ í™•ì¸
 * Long ttl = redisTemplate.getExpire(cacheKey);
 * // ttl: ë‚¨ì€ ì‹œê°„ (ì´ˆ)
 * // -1: TTLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ
 * // -2: í‚¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
 * ```
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ“Š TTL ë²”ìœ„ ê²€ì¦ ë¡œì§
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * TTL ì„¤ì • í›„ ì¦‰ì‹œ ì¡°íšŒí•˜ë©´:
 * - ì´ìƒì : ì„¤ì •ê°’ (ì˜ˆ: 3600ì´ˆ)
 * - í˜„ì‹¤ì : ì„¤ì •ê°’ - ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„ (ì˜ˆ: 3597-3599ì´ˆ)
 *
 * ë”°ë¼ì„œ ë²”ìœ„ ê²€ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤:
 * - ìµœì†Œê°’: TTL ì„¤ì •ê°’ - 10ì´ˆ (ì¿¼ë¦¬ ì§€ì—° í—ˆìš©)
 * - ìµœëŒ€ê°’: TTL ì„¤ì •ê°’ (ì •í™•í•œ ê°’)
 *
 * ```java
 * Long ttl = redisTemplate.getExpire(cacheKey);
 * assertThat(ttl).isGreaterThan(3590);        // 1ì‹œê°„ - 10ì´ˆ
 * assertThat(ttl).isLessThanOrEqualTo(3600);  // 1ì‹œê°„
 * ```
 *
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ”§ í…ŒìŠ¤íŠ¸ ì´ì 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 1. ìºì‹œ ì„¤ì • ê²€ì¦: CacheConfig.javaì˜ TTL ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
 * 2. Redis ì—°ê²° í™•ì¸: RedisTemplateì´ ì‹¤ì œ Redisì™€ í†µì‹ í•˜ëŠ”ì§€ í™•ì¸
 * 3. ì„±ëŠ¥ ì˜ˆì¸¡: TTLì„ ì•Œë©´ ìºì‹œ ê°±ì‹  ë¹ˆë„ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ìˆìŒ
 * 4. ë©”ëª¨ë¦¬ ê´€ë¦¬: TTLì´ ë„ˆë¬´ ê¸¸ë©´ ë©”ëª¨ë¦¬ ë‚­ë¹„, ë„ˆë¬´ ì§§ìœ¼ë©´ ìºì‹œ íš¨ìœ¨ ì €í•˜
 */
@SpringBootTest
@DisplayName("Redis ìºì‹œ TTL ê²€ì¦ í…ŒìŠ¤íŠ¸")
class RedisCacheTTLTest extends BaseIntegrationTest {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì˜ì¡´ì„± ì£¼ì…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    @Autowired
    private ProductService productService;

    @Autowired
    private ProductRepository productRepository;

    @Autowired
    private CacheManager cacheManager;

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    private Long productId;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    @BeforeEach
    void setUp() {
        // ìºì‹œ ì´ˆê¸°í™”
        clearAllCaches();

        // ìƒí’ˆ ìƒì„±
        Product product = Product.builder()
                .productName("TTL ê²€ì¦ìš© ìƒí’ˆ")
                .description("ìºì‹œ TTL ê²€ì¦ í…ŒìŠ¤íŠ¸")
                .price(75000L)
                .totalStock(100)
                .status("ACTIVE")
                .createdAt(LocalDateTime.now())
                .build();
        productRepository.save(product);

        // ìƒí’ˆ ì˜µì…˜ ìƒì„±
        if (product.getProductId() != null) {
            ProductOption option = ProductOption.builder()
                    .productId(product.getProductId())
                    .name("ê¸°ë³¸ ì˜µì…˜")
                    .stock(100)
                    .version(0L)
                    .build();
            productRepository.saveOption(option);
            productId = product.getProductId();
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… í…ŒìŠ¤íŠ¸ 1: ProductDetail - TTL ê²€ì¦ (2ì‹œê°„)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    @Test
    @DisplayName("ìƒí’ˆ ìƒì„¸ ì¡°íšŒ - ProductDetail ìºì‹œ TTL ê²€ì¦ (2ì‹œê°„)")
    void testProductDetail_TTL_Verification() {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Step 1: ìºì‹œ ì €ì¥
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Given: ìƒí’ˆ ìƒì„¸ ì¡°íšŒë¥¼ í†µí•´ Redis ìºì‹œ ì €ì¥
        ProductDetailResponse result = productService.getProductDetail(productId);

        assertThat(result).isNotNull();
        assertThat(result.getProductId()).isEqualTo(productId);
        System.out.println("âœ… ìƒí’ˆ ìƒì„¸ ì¡°íšŒ ì™„ë£Œ: " + productId);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Step 2: Redis ìºì‹œ í™•ì¸
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When: Redisì—ì„œ ìºì‹œ í‚¤ë¥¼ í™•ì¸
        String cacheKey = "cache:productDetail::" + productId;
        Object cachedValue = redisTemplate.opsForValue().get(cacheKey);

        assertThat(cachedValue)
                .as("Redisì— ìºì‹œê°€ ì €ì¥ë˜ì—ˆëŠ”ê°€?")
                .isNotNull();
        System.out.println("âœ… Redis ìºì‹œ ì¡´ì¬: " + cacheKey);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Step 3: TTL ê²€ì¦
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When: RedisTemplateìœ¼ë¡œ TTL ì¡°íšŒ
        Long ttl = redisTemplate.getExpire(cacheKey);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š TTL ê²€ì¦ ë¡œì§
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // productDetail ìºì‹œì˜ TTLì€ 2ì‹œê°„ = 7200ì´ˆ
        // ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„(~10ì´ˆ)ë¥¼ ê³ ë ¤í•œ ë²”ìœ„ ê²€ì¦

        System.out.println("\nğŸ“Š TTL ê²€ì¦ ê²°ê³¼:");
        System.out.println("   ìºì‹œ í‚¤: " + cacheKey);
        System.out.println("   í˜„ì¬ TTL: " + ttl + "ì´ˆ");
        System.out.println("   ê¸°ëŒ€ê°’: 7200ì´ˆ (2ì‹œê°„)");

        assertThat(ttl)
                .as("TTLì´ ì„¤ì •ë˜ì–´ì•¼ í•¨ (ìŒìˆ˜ê°€ ì•„ë‹˜)")
                .isGreaterThan(0);

        assertThat(ttl)
                .as("TTLì´ 2ì‹œê°„(7200ì´ˆ) ë²”ìœ„ ë‚´ì— ìˆì–´ì•¼ í•¨ (ìµœì†Œ: 7190ì´ˆ)")
                .isGreaterThan(7190);

        assertThat(ttl)
                .as("TTLì´ ì„¤ì •ê°’ ì´í•˜ì—¬ì•¼ í•¨ (ìµœëŒ€: 7200ì´ˆ)")
                .isLessThanOrEqualTo(7200);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // âœ¨ ê²°ë¡ 
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        System.out.println("âœ… ProductDetail ìºì‹œì˜ TTLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        System.out.println("âœ… ìºì‹œëŠ” ì•½ " + ttl + "ì´ˆ í›„ì— ìë™ìœ¼ë¡œ ë§Œë£Œë©ë‹ˆë‹¤.");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… í…ŒìŠ¤íŠ¸ 2: ProductList - TTL ê²€ì¦ (1ì‹œê°„)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    @Test
    @DisplayName("ìƒí’ˆ ëª©ë¡ ì¡°íšŒ - ProductList ìºì‹œ TTL ê²€ì¦ (1ì‹œê°„)")
    void testProductList_TTL_Verification() {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Step 1: ìºì‹œ ì €ì¥
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Given: ìƒí’ˆ ëª©ë¡ ì¡°íšŒë¥¼ í†µí•´ Redis ìºì‹œ ì €ì¥
        var result = productService.getProductList(0, 10, "created_at,desc");

        assertThat(result).isNotNull();
        System.out.println("âœ… ìƒí’ˆ ëª©ë¡ ì¡°íšŒ ì™„ë£Œ");

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Step 2: Redis ìºì‹œ í™•ì¸
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When: Redisì—ì„œ ìºì‹œ í‚¤ë¥¼ í™•ì¸
        String cacheKey = "cache:productList::list_0_10_created_at,desc";
        Object cachedValue = redisTemplate.opsForValue().get(cacheKey);

        assertThat(cachedValue)
                .as("Redisì— ìºì‹œê°€ ì €ì¥ë˜ì—ˆëŠ”ê°€?")
                .isNotNull();
        System.out.println("âœ… Redis ìºì‹œ ì¡´ì¬: " + cacheKey);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Step 3: TTL ê²€ì¦
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When: RedisTemplateìœ¼ë¡œ TTL ì¡°íšŒ
        Long ttl = redisTemplate.getExpire(cacheKey);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ğŸ“Š TTL ê²€ì¦ ë¡œì§
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // productList ìºì‹œì˜ TTLì€ 1ì‹œê°„ = 3600ì´ˆ

        System.out.println("\nğŸ“Š TTL ê²€ì¦ ê²°ê³¼:");
        System.out.println("   ìºì‹œ í‚¤: " + cacheKey);
        System.out.println("   í˜„ì¬ TTL: " + ttl + "ì´ˆ");
        System.out.println("   ê¸°ëŒ€ê°’: 3600ì´ˆ (1ì‹œê°„)");

        assertThat(ttl)
                .as("TTLì´ ì„¤ì •ë˜ì–´ì•¼ í•¨ (ìŒìˆ˜ê°€ ì•„ë‹˜)")
                .isGreaterThan(0);

        assertThat(ttl)
                .as("TTLì´ 1ì‹œê°„(3600ì´ˆ) ë²”ìœ„ ë‚´ì— ìˆì–´ì•¼ í•¨ (ìµœì†Œ: 3590ì´ˆ)")
                .isGreaterThan(3590);

        assertThat(ttl)
                .as("TTLì´ ì„¤ì •ê°’ ì´í•˜ì—¬ì•¼ í•¨ (ìµœëŒ€: 3600ì´ˆ)")
                .isLessThanOrEqualTo(3600);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // âœ¨ ê²°ë¡ 
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        System.out.println("âœ… ProductList ìºì‹œì˜ TTLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        System.out.println("âœ… ìºì‹œëŠ” ì•½ " + ttl + "ì´ˆ í›„ì— ìë™ìœ¼ë¡œ ë§Œë£Œë©ë‹ˆë‹¤.");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… í…ŒìŠ¤íŠ¸ 3: TTLì´ ì„¤ì •ë˜ì§€ ì•Šì€ ìºì‹œ ì˜¤ë¥˜ ê²€ì¦
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    @Test
    @DisplayName("ìºì‹œ TTL ì„¤ì • ì‹¤íŒ¨ - ì˜¤ë¥˜ ê²€ì¦")
    void testCacheTTL_NotSet_ErrorDetection() {
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Given: ìºì‹œê°€ ì €ì¥ë¨
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        productService.getProductDetail(productId);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When & Then: TTLì´ ì„¤ì •ëœ ìºì‹œ ê²€ì¦
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        String cacheKey = "cache:productDetail::" + productId;
        Long ttl = redisTemplate.getExpire(cacheKey);

        System.out.println("\nğŸ” TTL ì„¤ì • ìƒíƒœ í™•ì¸:");
        System.out.println("   TTL ê°’: " + ttl);
        System.out.println("   -1 = TTL ì„¤ì • ì•ˆë¨");
        System.out.println("   -2 = ìºì‹œ í‚¤ê°€ ì—†ìŒ");
        System.out.println("   ì–‘ìˆ˜ = TTL ì„¤ì •ë¨ (ì¶”ì²œ)");

        // TTLì´ ì„¤ì •ë˜ì–´ì•¼ í•¨ (-1ì€ TTLì´ ì—†ëŠ” ìƒíƒœ)
        assertThat(ttl)
                .as("TTLì´ ì„¤ì •ë˜ì–´ì•¼ í•¨. -1ì€ TTLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒì„ ì˜ë¯¸í•¨")
                .isGreaterThan(-1);

        // TTLì´ 0ì´ ì•„ë‹˜ (ìºì‹œê°€ ì¦‰ì‹œ ë§Œë£Œë˜ì§€ ì•ŠìŒ)
        assertThat(ttl)
                .as("TTLì´ 0ë³´ë‹¤ ì»¤ì•¼ í•¨ (ìºì‹œê°€ ì¦‰ì‹œ ë§Œë£Œë˜ë©´ ì•ˆë¨)")
                .isGreaterThan(0);

        System.out.println("âœ… TTLì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // í—¬í¼ ë©”ì„œë“œ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /**
     * ëª¨ë“  ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í—¬í¼ ë©”ì„œë“œ
     */
    private void clearAllCaches() {
        if (cacheManager != null) {
            cacheManager.getCacheNames().forEach(cacheName -> {
                var cache = cacheManager.getCache(cacheName);
                if (cache != null) {
                    cache.clear();
                }
            });
        }
    }
}
