# Kafka ê¸°ì´ˆ ê°œë… - E-Commerce ì£¼ë¬¸ ì´ë²¤íŠ¸ ê´€ì 

---

## ëª©ì°¨
- [1. Kafkaë€ ë¬´ì—‡ì¸ê°€?](#1-kafkaë€-ë¬´ì—‡ì¸ê°€)
- [2. Kafka í•µì‹¬ êµ¬ì„± ìš”ì†Œ](#2-kafka-í•µì‹¬-êµ¬ì„±-ìš”ì†Œ)
- [3. ë©”ì‹œì§€ ì „ë‹¬ íë¦„](#3-ë©”ì‹œì§€-ì „ë‹¬-íë¦„)
- [4. ë©”ì‹œì§€ Keyì™€ íŒŒí‹°ì…”ë‹](#4-ë©”ì‹œì§€-keyì™€-íŒŒí‹°ì…”ë‹)
- [5. Consumer Groupê³¼ ë³‘ë ¬ ì²˜ë¦¬](#5-consumer-groupê³¼-ë³‘ë ¬-ì²˜ë¦¬)
- [6. ë©”ì‹œì§€ ì „ë‹¬ ë³´ì¥ ìˆ˜ì¤€](#6-ë©”ì‹œì§€-ì „ë‹¬-ë³´ì¥-ìˆ˜ì¤€)
- [7. KRaft ëª¨ë“œ - Controller ì¤‘ì‹¬ ë©”íƒ€ë°ì´í„° ê´€ë¦¬](#7-kraft-ëª¨ë“œ---controller-ì¤‘ì‹¬-ë©”íƒ€ë°ì´í„°-ê´€ë¦¬)
- [8. Kafka UI í™œìš©](#8-kafka-ui-í™œìš©)
- [9. ì‹¤ë¬´ ì ìš© ì‹œë‚˜ë¦¬ì˜¤](#9-ì‹¤ë¬´-ì ìš©-ì‹œë‚˜ë¦¬ì˜¤)

---

## 1. Kafkaë€ ë¬´ì—‡ì¸ê°€?

### ê°œìš”
KafkaëŠ” **ë¶„ì‚° ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° í”Œë«í¼**ì…ë‹ˆë‹¤. ì‰½ê²Œ ë§í•´, ì‹œìŠ¤í…œ ê°„ ë©”ì‹œì§€(ì´ë²¤íŠ¸)ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ë©”ì‹œì§€ íì…ë‹ˆë‹¤.

### ì™œ Kafkaë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

**ê¸°ì¡´ ë°©ì‹ì˜ ë¬¸ì œì :**
```
ì£¼ë¬¸ ì„œë¹„ìŠ¤ â†’ (ì§ì ‘ í˜¸ì¶œ) â†’ ì¬ê³  ì„œë¹„ìŠ¤
             â†’ (ì§ì ‘ í˜¸ì¶œ) â†’ ì•Œë¦¼ ì„œë¹„ìŠ¤
             â†’ (ì§ì ‘ í˜¸ì¶œ) â†’ ë¶„ì„ ì„œë¹„ìŠ¤
```
- ì„œë¹„ìŠ¤ ê°„ ê°•í•œ ê²°í•©
- í•œ ì„œë¹„ìŠ¤ ì¥ì•  ì‹œ ì „ì²´ ì£¼ë¬¸ ì²˜ë¦¬ ì‹¤íŒ¨
- ë™ê¸° ì²˜ë¦¬ë¡œ ì¸í•œ ì‘ë‹µ ì§€ì—°

**Kafka ë„ì… í›„:**
```
ì£¼ë¬¸ ì„œë¹„ìŠ¤ â†’ Kafka (order-events í† í”½)
              â†“
              â”œâ†’ ì¬ê³  ì„œë¹„ìŠ¤ (ë…ë¦½ì ìœ¼ë¡œ ì½ì–´ê°)
              â”œâ†’ ì•Œë¦¼ ì„œë¹„ìŠ¤ (ë…ë¦½ì ìœ¼ë¡œ ì½ì–´ê°)
              â””â†’ ë¶„ì„ ì„œë¹„ìŠ¤ (ë…ë¦½ì ìœ¼ë¡œ ì½ì–´ê°)
```
- ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ê²°í•©
- ê°œë³„ ì„œë¹„ìŠ¤ ì¥ì• ê°€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ ì—†ìŒ
- ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ë¹ ë¥¸ ì‘ë‹µ

### E-Commerce í”„ë¡œì íŠ¸ì—ì„œì˜ ì—­í• 
ì£¼ë¬¸ ìƒì„±, ì¬ê³  ë³€ê²½, ê²°ì œ ì™„ë£Œ ë“±ì˜ **ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  êµ¬ë…**í•˜ëŠ” ì¤‘ì•™ ë©”ì‹œì§€ í—ˆë¸Œ ì—­í• ì„ í•©ë‹ˆë‹¤.

---

## 2. Kafka í´ëŸ¬ìŠ¤í„° ì•„í‚¤í…ì²˜

### 2.0 í´ëŸ¬ìŠ¤í„° ê°œìš”

**í´ëŸ¬ìŠ¤í„°(Cluster)ë€?**

ì—¬ëŸ¬ Kafka Brokerê°€ í•˜ë‚˜ì˜ ë…¼ë¦¬ì  ë‹¨ìœ„ë¡œ ë™ì‘í•˜ëŠ” ë¶„ì‚° ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

**í´ëŸ¬ìŠ¤í„° êµ¬ì¡° ì‹œê°í™”:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Kafka Cluster                          â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Broker 1    â”‚ â”‚  Broker 2    â”‚ â”‚  Broker 3    â”‚â”‚
â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚â”‚
â”‚  â”‚ Partition 0-Lâ”‚ â”‚ Partition 1-Lâ”‚ â”‚ Partition 2-Lâ”‚â”‚  L: Leader
â”‚  â”‚ Partition 1-Fâ”‚ â”‚ Partition 2-Fâ”‚ â”‚ Partition 0-Fâ”‚â”‚  F: Follower
â”‚  â”‚ Partition 2-Fâ”‚ â”‚ Partition 0-Fâ”‚ â”‚ Partition 1-Fâ”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  íŒŒí‹°ì…˜ì´ ë¸Œë¡œì»¤ì— ë¶„ì‚° ì €ì¥ + ë³µì œë¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                â†‘                â†‘
     KRaft Controller ë©”íƒ€ë°ì´í„° ê´€ë¦¬ (ë¦¬ë” ì„ ì¶œ, í´ëŸ¬ìŠ¤í„° ìƒíƒœ)
```

**ë‹¨ì¼ ë¸Œë¡œì»¤ vs í´ëŸ¬ìŠ¤í„° ë¹„êµ:**

| ë¹„êµ í•­ëª© | ë‹¨ì¼ ë¸Œë¡œì»¤ | í´ëŸ¬ìŠ¤í„° (3 ë¸Œë¡œì»¤) |
|---------|-----------|-------------------|
| **ê°€ìš©ì„±** | Broker ì¥ì•  â†’ ì „ì²´ ì¤‘ë‹¨ âŒ | 1ê°œ Broker ì¥ì•  â†’ ì„œë¹„ìŠ¤ ìœ ì§€ âœ…<br/>2ê°œ Broker ì¥ì•  â†’ ì„œë¹„ìŠ¤ ì¥ì•  ê°€ëŠ¥ì„± ë†’ìŒ âš ï¸ |
| **ì²˜ë¦¬ëŸ‰** | ì œí•œì  (1ëŒ€ í•œê³„) | 3ë°° ì´ìƒ í™•ì¥ ê°€ëŠ¥ |
| **ë°ì´í„° ì•ˆì •ì„±** | ë””ìŠ¤í¬ ì¥ì•  â†’ ë°ì´í„° ì†ì‹¤ | ë³µì œë¡œ ì†ì‹¤ ë°©ì§€ |
| **í™•ì¥ì„±** | ë¶ˆê°€ëŠ¥ | Broker ì¶”ê°€ë¡œ ìˆ˜í‰ í™•ì¥ |
| **ë¶€í•˜ ë¶„ì‚°** | ë¶ˆê°€ëŠ¥ | íŒŒí‹°ì…˜ ë¦¬ë”ê°€ ë¸Œë¡œì»¤ ê°„ ë¶„ì‚° |

**ì™œ ë³´í†µ 3ê°œ ì´ìƒ ë¸Œë¡œì»¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?**

1. **ê³ ê°€ìš©ì„± (High Availability)**
   ```
   3ê°œ ë¸Œë¡œì»¤ + Replication Factor 3:
   - 1ê°œ ë¸Œë¡œì»¤ ì¥ì•  â†’ ì •ìƒ ì„œë¹„ìŠ¤ ìœ ì§€ âœ…
   - 2ê°œ ë¸Œë¡œì»¤ ì¥ì•  â†’ ë°ì´í„° ë³´ì¡´ì€ ê°€ëŠ¥í•˜ë‚˜ ì„œë¹„ìŠ¤ ì¥ì•  ê°€ëŠ¥ì„± ë†’ìŒ âš ï¸
     â†’ ISR ë¶€ì¡±, Controller quorum ìƒì‹¤ ë“± ë³µí•© ì¥ì•  ë°œìƒ ê°€ëŠ¥
     â†’ ì‹¤ë¬´ì—ì„œëŠ” 2ê°œ ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë¹„ì •ìƒ ìƒí™©ìœ¼ë¡œ ê°„ì£¼
   ```

2. **ê³¼ë°˜ìˆ˜ ê¸°ë°˜ ì˜ì‚¬ê²°ì • (Quorum)**
   ```
   KRaft ControllerëŠ” ê³¼ë°˜ìˆ˜ í•©ì˜ë¡œ ë¦¬ë” ì„ ì¶œ:
   - 3ê°œ ë¸Œë¡œì»¤: 2ê°œ ì´ìƒ ë™ì˜ í•„ìš” (ê³¼ë°˜ìˆ˜)
   - ë„¤íŠ¸ì›Œí¬ ë¶„ë¦¬ ì‹œì—ë„ ì•ˆì •ì  ìš´ì˜
   ```

3. **ë¶€í•˜ ë¶„ì‚°**
   ```
   order-events (3ê°œ íŒŒí‹°ì…˜, 3ê°œ ë¸Œë¡œì»¤)

   Broker 1: Partition 0 Leader, Partition 1/2 Follower
   Broker 2: Partition 1 Leader, Partition 0/2 Follower
   Broker 3: Partition 2 Leader, Partition 0/1 Follower

   â‡’ ê° ë¸Œë¡œì»¤ê°€ ì¼ë¶€ íŒŒí‹°ì…˜ì˜ Leader ì—­í• 
   â‡’ ì½ê¸°/ì“°ê¸° ë¶€í•˜ê°€ ë¸Œë¡œì»¤ ê°„ ê· ë“± ë¶„ì‚°
   ```

4. **ê¶Œì¥ êµ¬ì„±**
   - **ê°œë°œ í™˜ê²½**: 1ê°œ ë¸Œë¡œì»¤ (í¸ì˜ì„±)
   - **ìš´ì˜ í™˜ê²½**: 3ê°œ ì´ìƒ ë¸Œë¡œì»¤ (ì•ˆì •ì„±)
   - **ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ**: 5ê°œ ì´ìƒ ë¸Œë¡œì»¤ (2ê°œ ì¥ì•  í—ˆìš© + ì—¬ìœ )

**E-Commerce í”„ë¡œì íŠ¸ í™˜ê²½:**
```yaml
# í˜„ì¬: ë¡œì»¬ ê°œë°œ í™˜ê²½
brokers: 1  # Docker Compose ë‹¨ì¼ ë¸Œë¡œì»¤

# ìš´ì˜ í™˜ê²½ ê¶Œì¥:
brokers: 3  # Kubernetesì— 3ê°œ Broker Pod ë°°í¬
replication-factor: 3  # ëª¨ë“  íŒŒí‹°ì…˜ 3ê°œ ë³µì œë³¸
min.insync.replicas: 2  # ìµœì†Œ 2ê°œ ë³µì œë³¸ ë™ê¸°í™” í•„ìš”
```

---

## 3. Kafka í•µì‹¬ êµ¬ì„± ìš”ì†Œ

### 2.1 Broker (ë¸Œë¡œì»¤)

**ì •ì˜:** Kafka ì„œë²„ ì¸ìŠ¤í„´ìŠ¤. ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³  ì „ë‹¬í•˜ëŠ” ì—­í• .

**í”„ë¡œì íŠ¸ êµ¬ì„±:**
- í˜„ì¬: ë‹¨ì¼ ë¸Œë¡œì»¤ (ë¡œì»¬ ê°œë°œ í™˜ê²½)
- ìš´ì˜ í™˜ê²½: ì¼ë°˜ì ìœ¼ë¡œ 3ê°œ ì´ìƒì˜ ë¸Œë¡œì»¤ í´ëŸ¬ìŠ¤í„°

**ë¹„ìœ :**
ìš°ì²´êµ­ í•˜ë‚˜ë¼ê³  ìƒê°í•˜ë©´ ë©ë‹ˆë‹¤. í¸ì§€(ë©”ì‹œì§€)ë¥¼ ë°›ì•„ì„œ ë³´ê´€í•˜ê³ , ë°›ëŠ” ì‚¬ëŒ(Consumer)ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.

---

### 2.2 Topic (í† í”½)

**ì •ì˜:** ë©”ì‹œì§€ë¥¼ ë¶„ë¥˜í•˜ëŠ” ì¹´í…Œê³ ë¦¬. ë©”ì‹œì§€ê°€ ì €ì¥ë˜ëŠ” ë…¼ë¦¬ì  ê³µê°„.

**E-Commerce ì˜ˆì‹œ:**
```
order-events        : ì£¼ë¬¸ ìƒì„±/ì·¨ì†Œ ì´ë²¤íŠ¸
payment-events      : ê²°ì œ ì™„ë£Œ/ì‹¤íŒ¨ ì´ë²¤íŠ¸
inventory-events    : ì¬ê³  ì°¨ê°/ë³µêµ¬ ì´ë²¤íŠ¸
notification-events : ì•Œë¦¼ ë°œì†¡ ì´ë²¤íŠ¸
```

**íŠ¹ì§•:**
- í•˜ë‚˜ì˜ í† í”½ì€ ì—¬ëŸ¬ íŒŒí‹°ì…˜ìœ¼ë¡œ êµ¬ì„±
- ë©”ì‹œì§€ëŠ” í† í”½ì— ì˜êµ¬ ì €ì¥ (ì„¤ì •ëœ ë³´ê´€ ê¸°ê°„ ë™ì•ˆ)
- ì—¬ëŸ¬ Consumerê°€ ë™ì¼í•œ í† í”½ì„ êµ¬ë… ê°€ëŠ¥

**ë¹„ìœ :**
í† í”½ì€ ì‹ ë¬¸ì˜ ì„¹ì…˜(ìŠ¤í¬ì¸ , ê²½ì œ, ì‚¬íšŒ)ê³¼ ê°™ìŠµë‹ˆë‹¤. ë…ìëŠ” ì›í•˜ëŠ” ì„¹ì…˜ë§Œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

### 2.3 Partition (íŒŒí‹°ì…˜)

**ì •ì˜:** í† í”½ì„ ë¬¼ë¦¬ì ìœ¼ë¡œ ë‚˜ëˆˆ ë‹¨ìœ„. ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ í•µì‹¬ ê°œë….

**ì‹œê°í™”:**
```
order-events í† í”½ (3ê°œ íŒŒí‹°ì…˜)

Partition 0: [ì£¼ë¬¸1] [ì£¼ë¬¸4] [ì£¼ë¬¸7] ...
Partition 1: [ì£¼ë¬¸2] [ì£¼ë¬¸5] [ì£¼ë¬¸8] ...
Partition 2: [ì£¼ë¬¸3] [ì£¼ë¬¸6] [ì£¼ë¬¸9] ...
```

**ì™œ íŒŒí‹°ì…˜ì´ í•„ìš”í•œê°€?**
1. **ë³‘ë ¬ ì²˜ë¦¬**: íŒŒí‹°ì…˜ë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ Consumer í• ë‹¹ ê°€ëŠ¥
2. **í™•ì¥ì„±**: íŒŒí‹°ì…˜ì„ ëŠ˜ë ¤ ì²˜ë¦¬ ì„±ëŠ¥ í–¥ìƒ
3. **ê³ ê°€ìš©ì„±**: íŒŒí‹°ì…˜ ë³µì œ(Replication)ë¡œ ì¥ì•  ëŒ€ì‘

**E-Commerce ì˜ˆì‹œ:**
```yaml
# ì£¼ë¬¸ëŸ‰ì´ ë§ì€ ì‹œìŠ¤í…œ
order-events:
  partitions: 10  # 10ê°œ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„ì‚° ì²˜ë¦¬

# ì•Œë¦¼ì€ ìƒëŒ€ì ìœ¼ë¡œ ì ìŒ
notification-events:
  partitions: 3   # 3ê°œ íŒŒí‹°ì…˜ìœ¼ë¡œ ì¶©ë¶„
```

---

### 2.3.1 íŒŒí‹°ì…˜ ë³µì œì™€ ë¦¬ë”/íŒ”ë¡œì›Œ

**ì •ì˜**:
- **Replication (ë³µì œ)**: íŒŒí‹°ì…˜ì„ ì—¬ëŸ¬ ë¸Œë¡œì»¤ì— ë³µì‚¬í•˜ì—¬ ì €ì¥
- **Leader Replica**: ì½ê¸°/ì“°ê¸°ë¥¼ ë‹´ë‹¹í•˜ëŠ” ì£¼ ë³µì œë³¸
- **Follower Replica**: Leaderë¥¼ ë³µì œí•˜ë©° ì¥ì•  ëŒ€ë¹„ìš© ë°±ì—… ë³µì œë³¸

**ì™œ ë³µì œê°€ í•„ìš”í•œê°€?**
1. **ê³ ê°€ìš©ì„±**: Leader ì¥ì•  ì‹œ Followerê°€ ì¦‰ì‹œ ëŒ€ì²´
2. **ë°ì´í„° ì•ˆì •ì„±**: ì—¬ëŸ¬ ë¸Œë¡œì»¤ì— ë³µì œë˜ì–´ ì†ì‹¤ ë°©ì§€
3. **ì¥ì•  ë³µêµ¬**: ë¸Œë¡œì»¤ ì¥ì• ì—ë„ ì„œë¹„ìŠ¤ ì§€ì†

**íŒŒí‹°ì…˜ ë³µì œ êµ¬ì¡°:**

```
order-events Partition 0 (Replication Factor = 3)

Broker 1: [Partition 0 - Leader]      â† Producer/Consumer ì—°ê²°
           â†“ ë³µì œ
Broker 2: [Partition 0 - Follower]    â† Leader ë°ì´í„° ë³µì œ
           â†“ ë³µì œ
Broker 3: [Partition 0 - Follower]    â† Leader ë°ì´í„° ë³µì œ

âš ï¸ ì¤‘ìš”: Producerì™€ ConsumerëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Leaderì— ì ‘ê·¼
   - Producer: acks=all ì„¤ì • ì‹œ Follower(ISR)ì˜ ë³µì œ ì‘ë‹µë„ ëŒ€ê¸°
   - Consumer: ì¼ë¶€ ì„¤ì •(rack-aware ë“±)ì—ì„œ Follower ì½ê¸° ê°€ëŠ¥ (ë¹„í‘œì¤€)
```

**Leaderì™€ Followerì˜ ì—­í• :**

| ì—­í•  | Leader Replica | Follower Replica |
|------|---------------|-----------------|
| **ì½ê¸°** | âœ… Consumer ê¸°ë³¸ ì½ê¸° ëŒ€ìƒ | âš ï¸ íŠ¹ì • ì„¤ì • ì‹œ ê°€ëŠ¥ (rack-aware) |
| **ì“°ê¸°** | âœ… Producer ì“°ê¸° ì²˜ë¦¬ | âŒ ì“°ê¸° ì•ˆ í•¨ (Leaderë§Œ) |
| **ë³µì œ** | - | âœ… Leader ë°ì´í„° ë³µì œ |
| **ì¥ì•  ëŒ€ì‘** | - | âœ… Leader ì¥ì•  ì‹œ ìŠ¹ê²© |

**ë™ì‘ íë¦„:**

```
[ì •ìƒ ìƒí™©]
Producer â†’ Leader (Broker 1) â†’ ë©”ì‹œì§€ ì €ì¥
           â†“ ë³µì œ (ë™ê¸°í™”)
        Follower (Broker 2)
        Follower (Broker 3)

Consumer â† Leader (Broker 1) â† ë©”ì‹œì§€ ì½ê¸°

[Leader ì¥ì•  ì‹œ]
Broker 1 ì¥ì•  ê°ì§€ (KRaft Controller)
  â†“
ISR ì¤‘ í•˜ë‚˜ë¥¼ ìƒˆë¡œìš´ Leaderë¡œ ì„ ì¶œ (Broker 2)
  â†“
Producer/ConsumerëŠ” ìƒˆë¡œìš´ Leaderë¡œ ìë™ ì¬ì—°ê²°
```

**ISR (In-Sync Replicas) ê°œë…:**

```
ISR = Leaderì™€ ë™ê¸°í™” ìƒíƒœë¥¼ ìœ ì§€í•˜ëŠ” Follower ëª©ë¡

order-events Partition 0:
- Broker 1 (Leader)         â† ISR âœ…
- Broker 2 (Follower)       â† ISR âœ… (Leaderì™€ ë™ê¸°í™” ì™„ë£Œ)
- Broker 3 (Follower)       â† ISR âŒ (ë™ê¸°í™” ì§€ì—° ì¤‘)

âš ï¸ Broker 3ì€ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ISRì—ì„œ ì œì™¸ë¨
â‡’ Leader ì¥ì•  ì‹œ Broker 2ë§Œ Leader í›„ë³´
```

**ì™œ ISRì´ ì¤‘ìš”í•œê°€?**
- ISRì— í¬í•¨ëœ Followerë§Œ Leaderë¡œ ìŠ¹ê²© ê°€ëŠ¥
- ISRì´ ì—†ìœ¼ë©´ ë°ì´í„° ì†ì‹¤ ê°€ëŠ¥
- `acks=all` ì„¤ì • ì‹œ ëª¨ë“  ISRì´ í™•ì¸í•´ì•¼ Ack ë°˜í™˜

**acks ì„¤ì •ê³¼ ë³µì œì˜ ê´€ê³„:**

```yaml
# Producer ì„¤ì •

acks: 0  # ì‘ë‹µ í™•ì¸ ì•ˆ í•¨
  â‡’ Leaderì— ì „ì†¡ë§Œ í•˜ê³  ì¦‰ì‹œ ë°˜í™˜
  â‡’ ê°€ì¥ ë¹ ë¥´ì§€ë§Œ Leader ì¥ì•  ì‹œ ì†ì‹¤ ê°€ëŠ¥ âŒ

acks: 1  # Leaderë§Œ í™•ì¸
  â‡’ Leaderê°€ ë””ìŠ¤í¬ì— ì €ì¥ í›„ Ack
  â‡’ ë¹ ë¥´ì§€ë§Œ Leader ì¥ì•  ì‹œ Follower ë¯¸ë³µì œ ë°ì´í„° ì†ì‹¤ âš ï¸

acks: all (ë˜ëŠ” -1)  # ëª¨ë“  ISR í™•ì¸ (ê¶Œì¥)
  â‡’ Leader + ëª¨ë“  ISR Followerê°€ ì €ì¥ í›„ Ack
  â‡’ ê°€ì¥ ì•ˆì „í•˜ì§€ë§Œ ëŠë¦¼ âœ…
```

**E-Commerce í”„ë¡œì íŠ¸ ê¶Œì¥ ì„¤ì •:**

```yaml
# í† í”½ ìƒì„± ì‹œ
order-events:
  partitions: 3
  replication-factor: 3  # 3ê°œ ë¸Œë¡œì»¤ì— ë³µì œ
  min.insync.replicas: 2  # ìµœì†Œ 2ê°œ ë³µì œë³¸ í™•ì¸ í•„ìš”

# Producer ì„¤ì •
spring:
  kafka:
    producer:
      acks: all  # ëª¨ë“  ISR í™•ì¸
      retries: 3  # ì „ì†¡ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
```

**ë³µì œ ì„¤ì • ì‹œë‚˜ë¦¬ì˜¤:**

```
ì‹œë‚˜ë¦¬ì˜¤ 1: Replication Factor = 1 (ë³µì œ ì—†ìŒ)
order-events Partition 0:
- Broker 1 (Leaderë§Œ)

â‡’ Broker 1 ì¥ì•  â†’ ë°ì´í„° ì†ì‹¤! âŒ

ì‹œë‚˜ë¦¬ì˜¤ 2: Replication Factor = 2
order-events Partition 0:
- Broker 1 (Leader)
- Broker 2 (Follower)

â‡’ Broker 1 ì¥ì•  â†’ Broker 2ê°€ Leaderë¡œ ìŠ¹ê²© âœ…
â‡’ 1ê°œ ë¸Œë¡œì»¤ ì¥ì• ê¹Œì§€ ê²¬ë”¤

ì‹œë‚˜ë¦¬ì˜¤ 3: Replication Factor = 3 (ê¶Œì¥)
order-events Partition 0:
- Broker 1 (Leader)
- Broker 2 (Follower)
- Broker 3 (Follower)

â‡’ 1ê°œ ë¸Œë¡œì»¤ ì¥ì• ê¹Œì§€ ì•ˆì •ì ìœ¼ë¡œ ê²¬ë”¤ âœ…
â‡’ 2ê°œ ë¸Œë¡œì»¤ ì¥ì•  ì‹œ ë°ì´í„°ëŠ” ë³´ì¡´ë˜ë‚˜ ì„œë¹„ìŠ¤ ì¥ì•  ê°€ëŠ¥ì„± ë†’ìŒ âš ï¸
   (ISR ë¶€ì¡±, min.insync.replicas ë¯¸ì¶©ì¡±, Controller quorum ìƒì‹¤ ë“±)
â‡’ ìš´ì˜ í™˜ê²½ ê¶Œì¥ ì„¤ì •
```

**Leader ì¬ì„ ì¶œ ê³¼ì •:**

```
1. Leader ì¥ì•  ê°ì§€
   KRaft Controllerê°€ Leader Brokerì˜ í•˜íŠ¸ë¹„íŠ¸ ì¤‘ë‹¨ ê°ì§€

2. ISR í™•ì¸
   ISR ëª©ë¡ì—ì„œ Leader í›„ë³´ ì„ ì •

3. ìƒˆë¡œìš´ Leader ì„ ì¶œ
   ISR ì¤‘ í•˜ë‚˜ë¥¼ ìƒˆë¡œìš´ Leaderë¡œ ì§€ì •

4. ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
   ëª¨ë“  ë¸Œë¡œì»¤ì— ìƒˆë¡œìš´ Leader ì •ë³´ ì „íŒŒ

5. Producer/Consumer ì¬ì—°ê²°
   í´ë¼ì´ì–¸íŠ¸ê°€ ìë™ìœ¼ë¡œ ìƒˆë¡œìš´ Leaderë¡œ ì¬ì—°ê²°

â±ï¸ ì „ì²´ ê³¼ì •: ì¼ë°˜ì ìœ¼ë¡œ ìˆ˜ ì´ˆ ì´ë‚´ ì™„ë£Œ
```

**ì£¼ì˜ì‚¬í•­:**

```
âŒ Replication Factorë¥¼ íŒŒí‹°ì…˜ ìˆ˜ë³´ë‹¤ í¬ê²Œ ì„¤ì •í•  ìˆ˜ ì—†ìŒ:
order-events:
  partitions: 3
  replication-factor: 5  # ì—ëŸ¬! (ë¸Œë¡œì»¤ê°€ 3ê°œë¿ì´ë©´ ìµœëŒ€ 3)

âœ… ì˜¬ë°”ë¥¸ ì„¤ì •:
order-events:
  partitions: 10
  replication-factor: 3  # OK (ë¸Œë¡œì»¤ 3ê°œ ì´ìƒ í•„ìš”)
```

---

### 2.3.2 íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ ì‹œ ì˜í–¥

íŒŒí‹°ì…˜ ìˆ˜ëŠ” ìš´ì˜ ì¤‘ì— **ì¦ê°€ë§Œ** ê°€ëŠ¥í•˜ë©°, **ê°ì†ŒëŠ” ë¶ˆê°€ëŠ¥**í•©ë‹ˆë‹¤.

**íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ ì‹œë‚˜ë¦¬ì˜¤:**

```
ì´ˆê¸°: order-events (3 partitions)
ë³€ê²½: order-events (5 partitions)
```

**1. ê¸°ì¡´ ë©”ì‹œì§€ ì˜í–¥:**
```
Partition 0: [msg1, msg4, msg7, ...] â† ê·¸ëŒ€ë¡œ ìœ ì§€
Partition 1: [msg2, msg5, msg8, ...] â† ê·¸ëŒ€ë¡œ ìœ ì§€
Partition 2: [msg3, msg6, msg9, ...] â† ê·¸ëŒ€ë¡œ ìœ ì§€
Partition 3: (ìƒˆë¡œ ìƒì„±, ë¹„ì–´ìˆìŒ)
Partition 4: (ìƒˆë¡œ ìƒì„±, ë¹„ì–´ìˆìŒ)

â‡’ ê¸°ì¡´ ë©”ì‹œì§€ëŠ” ì¬ë¶„ë°°ë˜ì§€ ì•ŠìŒ
```

**2. ìƒˆë¡œìš´ ë©”ì‹œì§€ ì˜í–¥:**
```java
// íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ ì „
hash("order-123") % 3 = 1 â†’ Partition 1

// íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ í›„
hash("order-123") % 5 = 3 â†’ Partition 3 (ë³€ê²½ë¨!)

âš ï¸ ë™ì¼ Keyë¼ë„ ë‹¤ë¥¸ íŒŒí‹°ì…˜ìœ¼ë¡œ ê°ˆ ìˆ˜ ìˆìŒ!
âš ï¸ ìˆœì„œ ë³´ì¥ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë§¤ìš° ì£¼ì˜!
```

**3. Consumer Rebalance ë°œìƒ:**
```
ë³€ê²½ ì „ (3 íŒŒí‹°ì…˜, 3 Consumer):
Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer B
Partition 2 â†’ Consumer C

ë³€ê²½ í›„ (5 íŒŒí‹°ì…˜, 3 Consumer):
Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer A  (ì¬í• ë‹¹)
Partition 2 â†’ Consumer B
Partition 3 â†’ Consumer B  (ìƒˆë¡œ í• ë‹¹)
Partition 4 â†’ Consumer C  (ìƒˆë¡œ í• ë‹¹)

â‡’ Rebalance ì¤‘ ì§§ì€ ì§€ì—° ë°œìƒ
```

**4. ì²˜ë¦¬ëŸ‰ ë³€í™”:**
```
3ê°œ íŒŒí‹°ì…˜ â†’ 5ê°œ íŒŒí‹°ì…˜:
- ì´ë¡ ì ìœ¼ë¡œ 5/3 = 1.67ë°° ì²˜ë¦¬ëŸ‰ ì¦ê°€ ê°€ëŠ¥
- ë‹¨, Consumerë„ í•¨ê»˜ ëŠ˜ë ¤ì•¼ íš¨ê³¼ì 
```

**ê¶Œì¥ ì‚¬í•­:**

```
âœ… DO:
- ì´ˆê¸° ì„¤ê³„ ì‹œ ì¶©ë¶„íˆ í¬ê²Œ ì„¤ì • (ì—¬ìœ  ìˆê²Œ)
- íŒŒí‹°ì…˜ ìˆ˜ = ì˜ˆìƒ ìµœëŒ€ Consumer ìˆ˜
- ì˜ˆì‹œ: ì²˜ë¦¬ëŸ‰ì´ 2ë°° ì¦ê°€ ì˜ˆìƒ â†’ íŒŒí‹°ì…˜ë„ 2ë°°ë¡œ ì„¤ì •

âŒ DON'T:
- ìì£¼ íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ (ìˆœì„œ ë³´ì¥ ê¹¨ì§)
- íŒŒí‹°ì…˜ ìˆ˜ë¥¼ ì¤„ì´ë ¤ ì‹œë„ (ë¶ˆê°€ëŠ¥)
- Consumer ìˆ˜ë³´ë‹¤ í›¨ì”¬ ì ê²Œ ì„¤ì •
```

**íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½ì´ ë¶ˆê°€í”¼í•œ ê²½ìš°:**

```
ì˜µì…˜ 1: ê¸°ì¡´ í† í”½ ìœ ì§€ + ìƒˆ í† í”½ ìƒì„±
- ìƒˆë¡œìš´ ë©”ì‹œì§€ëŠ” order-events-v2 (10 íŒŒí‹°ì…˜)ë¡œ ë°œí–‰
- ê¸°ì¡´ order-events (3 íŒŒí‹°ì…˜) ë©”ì‹œì§€ ì†Œì§„ í›„ ì œê±°

ì˜µì…˜ 2: ì „ì²´ ë°ì´í„° ì¬ì²˜ë¦¬
- íŒŒí‹°ì…˜ ìˆ˜ ë³€ê²½
- Consumer Offset ë¦¬ì…‹
- ì²˜ìŒë¶€í„° ì¬ì²˜ë¦¬ (ìˆœì„œ ë³´ì¥ í¬ê¸°)
```

---

### 2.4 Producer (í”„ë¡œë“€ì„œ)

**ì •ì˜:** Kafkaì— ë©”ì‹œì§€ë¥¼ **ë°œí–‰(publish)**í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜.

**E-Commerce ì˜ˆì‹œ:**
```java
// ì£¼ë¬¸ ì„œë¹„ìŠ¤ê°€ Producer ì—­í• 
@Service
public class OrderEventProducer {

    @Autowired
    private KafkaTemplate<String, OrderEvent> kafkaTemplate;

    public void publishOrderCreated(Order order) {
        OrderEvent event = OrderEvent.builder()
            .orderId(order.getOrderId())
            .userId(order.getUserId())
            .eventType("ORDER_CREATED")
            .timestamp(LocalDateTime.now())
            .build();

        // order-events í† í”½ì— ë©”ì‹œì§€ ë°œí–‰
        kafkaTemplate.send("order-events",
                          order.getOrderId().toString(), // Key
                          event);                        // Value
    }
}
```

**íŠ¹ì§•:**
- ë©”ì‹œì§€ë¥¼ ì–´ëŠ íŒŒí‹°ì…˜ì— ë³´ë‚¼ì§€ ê²°ì • (Key ê¸°ë°˜ ë˜ëŠ” Round-robin)
- ì „ì†¡ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ í¬í•¨
- ë¹„ë™ê¸° ì „ì†¡ìœ¼ë¡œ ë¹ ë¥¸ ì‘ë‹µ

---

### 2.5 Consumer (ì»¨ìŠˆë¨¸)

**ì •ì˜:** Kafkaë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ **êµ¬ë…(subscribe)**í•˜ê³  ì½ì–´ê°€ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜.

**E-Commerce ì˜ˆì‹œ:**
```java
// ì•Œë¦¼ ì„œë¹„ìŠ¤ê°€ Consumer ì—­í• 
@Service
public class NotificationEventConsumer {

    @KafkaListener(
        topics = "order-events",
        groupId = "notification-service-group"
    )
    public void handleOrderEvent(OrderEvent event) {
        if ("ORDER_CREATED".equals(event.getEventType())) {
            // ì£¼ë¬¸ ì™„ë£Œ ì•Œë¦¼ ë°œì†¡
            sendNotification(event.getUserId(),
                           "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }
}
```

**íŠ¹ì§•:**
- Poll ë°©ì‹ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ê° (Pushê°€ ì•„ë‹˜)
- ì½ì€ ë©”ì‹œì§€ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŒ (ë‹¤ë¥¸ Consumerë„ ì½ê¸° ê°€ëŠ¥)
- Offsetì„ í†µí•´ ì½ì€ ìœ„ì¹˜ ì¶”ì 

---

### 2.6 Consumer Group (ì»¨ìŠˆë¨¸ ê·¸ë£¹)

**ì •ì˜:** ë™ì¼í•œ í† í”½ì„ êµ¬ë…í•˜ëŠ” Consumerë“¤ì˜ ë…¼ë¦¬ì  ê·¸ë£¹.

**í•µì‹¬ ê°œë…:**
- ê°™ì€ ê·¸ë£¹ ë‚´ Consumerë“¤ì€ íŒŒí‹°ì…˜ì„ ë‚˜ëˆ ì„œ ì²˜ë¦¬
- ë‹¤ë¥¸ ê·¸ë£¹ì˜ Consumerë“¤ì€ ë…ë¦½ì ìœ¼ë¡œ ì „ì²´ ë©”ì‹œì§€ ì²˜ë¦¬

**ì‹œê°í™”:**
```
order-events í† í”½ (3ê°œ íŒŒí‹°ì…˜)

Partition 0 â†’ Consumer A (notification-group)
Partition 1 â†’ Consumer B (notification-group)
Partition 2 â†’ Consumer C (notification-group)

ë™ì‹œì—

Partition 0 â†’ Consumer X (analytics-group)
Partition 1 â†’ Consumer Y (analytics-group)
Partition 2 â†’ Consumer Z (analytics-group)
```

**E-Commerce ì˜ˆì‹œ:**
```yaml
# ê° ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ì¸ Consumer Group
notification-service:
  group-id: notification-service-group

analytics-service:
  group-id: analytics-service-group

inventory-service:
  group-id: inventory-service-group
```

**ì¥ì :**
- ì„œë¹„ìŠ¤ë³„ë¡œ ë…ë¦½ì ì¸ ì²˜ë¦¬ ì§„í–‰ë„ ê´€ë¦¬
- í•œ ì„œë¹„ìŠ¤ì˜ ì¥ì• ê°€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ ì—†ìŒ

---

### 2.7 Offset (ì˜¤í”„ì…‹)

**ì •ì˜:** íŒŒí‹°ì…˜ ë‚´ ë©”ì‹œì§€ì˜ ìˆœì°¨ì  ìœ„ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë²ˆí˜¸.

**ì‹œê°í™”:**
```
Partition 0
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Offset 0â”‚ Offset 1â”‚ Offset 2â”‚ Offset 3â”‚ Offset 4â”‚
â”‚ ì£¼ë¬¸1   â”‚ ì£¼ë¬¸2   â”‚ ì£¼ë¬¸3   â”‚ ì£¼ë¬¸4   â”‚ ì£¼ë¬¸5   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘
                Consumerì˜ í˜„ì¬ ìœ„ì¹˜ (Offset 2)
```

**ì—­í• :**
1. **ì¤‘ë³µ ë°©ì§€**: ì´ë¯¸ ì½ì€ ë©”ì‹œì§€ ì¬ì²˜ë¦¬ ë°©ì§€
2. **ì¬ì‹œì‘ ì•ˆì „**: Consumer ì¬ì‹œì‘ ì‹œ ë§ˆì§€ë§‰ ì½ì€ ìœ„ì¹˜ë¶€í„° ì¬ê°œ
3. **ì§„í–‰ ìƒí™© ì¶”ì **: ì–´ë””ê¹Œì§€ ì²˜ë¦¬í–ˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥

**Offset ê´€ë¦¬ ì „ëµ:**
```java
// Auto Commit (ìë™ ì»¤ë°‹)
spring.kafka.consumer.enable-auto-commit: true
spring.kafka.consumer.auto-commit-interval: 5000  # 5ì´ˆë§ˆë‹¤ ìë™ ì»¤ë°‹

// Manual Commit (ìˆ˜ë™ ì»¤ë°‹) - ê¶Œì¥
spring.kafka.consumer.enable-auto-commit: false

@KafkaListener(topics = "order-events")
public void consume(OrderEvent event, Acknowledgment ack) {
    try {
        processOrder(event);
        ack.acknowledge();  // ì²˜ë¦¬ ì™„ë£Œ í›„ ìˆ˜ë™ ì»¤ë°‹
    } catch (Exception e) {
        // ì¬ì²˜ë¦¬ ë¡œì§
    }
}
```

---

## 3. ë©”ì‹œì§€ ì „ë‹¬ íë¦„

### ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì£¼ë¬¸ ì„œë¹„ìŠ¤   â”‚  (Producer)
â”‚ OrderService â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. ì£¼ë¬¸ ì´ë²¤íŠ¸ ë°œí–‰
       â”‚    send("order-events", key="order123", value=OrderEvent)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Kafka Broker (localhost:9092)       â”‚
â”‚                                               â”‚
â”‚  Topic: order-events (3 Partitions)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Partition 0 â”‚ Partition 1 â”‚ Partition 2 â”‚ â”‚
â”‚  â”‚  [msg1]     â”‚  [msg2]     â”‚  [msg3]     â”‚ â”‚
â”‚  â”‚  [msg4]     â”‚  [msg5]     â”‚  [msg6]     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â”‚ 2. Poll       â”‚ 2. Poll        â”‚ 2. Poll
       â†“                â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Consumer Aâ”‚    â”‚Consumer Bâ”‚    â”‚Consumer Câ”‚
â”‚(ì•Œë¦¼ì„œë¹„ìŠ¤)â”‚    â”‚(ì¬ê³ ì„œë¹„ìŠ¤)â”‚    â”‚(ë¶„ì„ì„œë¹„ìŠ¤)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìƒì„¸ ë‹¨ê³„ë³„ íë¦„

#### Step 1: Producerê°€ ë©”ì‹œì§€ ë°œí–‰
```java
// ì£¼ë¬¸ ìƒì„± ì‹œ ì´ë²¤íŠ¸ ë°œí–‰
public Order createOrder(CreateOrderRequest request) {
    Order order = orderRepository.save(new Order(request));

    // Kafkaì— ì´ë²¤íŠ¸ ë°œí–‰ (ë¹„ë™ê¸°)
    OrderEvent event = OrderEvent.of(order);
    kafkaTemplate.send("order-events", order.getId().toString(), event);

    return order;  // ì¦‰ì‹œ ì‘ë‹µ (Kafka ì „ì†¡ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
}
```

#### Step 2: Brokerê°€ ë©”ì‹œì§€ ì €ì¥
1. ë©”ì‹œì§€ Key í•´ì‹±ìœ¼ë¡œ íŒŒí‹°ì…˜ ê²°ì •
2. í•´ë‹¹ íŒŒí‹°ì…˜ì— ë©”ì‹œì§€ ì¶”ê°€ (Append-only)
3. ë””ìŠ¤í¬ì— ì˜êµ¬ ì €ì¥

#### Step 3: Consumerê°€ ë©”ì‹œì§€ Poll
```java
// 5ì´ˆë§ˆë‹¤ ìµœëŒ€ 100ê°œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸° (ì„¤ì • ê°€ëŠ¥)
@KafkaListener(topics = "order-events", groupId = "inventory-group")
public void consumeOrderEvent(OrderEvent event) {
    log.info("ì£¼ë¬¸ ì´ë²¤íŠ¸ ìˆ˜ì‹ : {}", event.getOrderId());

    // ì¬ê³  ì°¨ê° ë¡œì§
    inventoryService.deductStock(event.getOrderItems());
}
```

---

### 3.4 ì—¬ëŸ¬ Producerì˜ ë™ì‹œ ë°œí–‰

**ì‹œë‚˜ë¦¬ì˜¤:**
ì—¬ëŸ¬ ì£¼ë¬¸ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤(Pod)ê°€ ë™ì‹œì— ê°™ì€ í† í”½ì— ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ëŠ” ê²½ìš°

**êµ¬ì¡°:**
```
ì£¼ë¬¸ ì„œë¹„ìŠ¤ Pod 1 â”€â”
ì£¼ë¬¸ ì„œë¹„ìŠ¤ Pod 2 â”€â”¼â”€â”€â†’ order-events (3 partitions)
ì£¼ë¬¸ ì„œë¹„ìŠ¤ Pod 3 â”€â”˜
```

**1. ë©”ì‹œì§€ëŠ” ì–´ëŠ íŒŒí‹°ì…˜ìœ¼ë¡œ ê°€ëŠ”ê°€?**

```
ê° ProducerëŠ” ë…ë¦½ì ìœ¼ë¡œ íŒŒí‹°ì…˜ ê²°ì •:

Pod 1: hash("order-123") % 3 = 1 â†’ Partition 1
Pod 2: hash("order-456") % 3 = 0 â†’ Partition 0
Pod 3: hash("order-789") % 3 = 2 â†’ Partition 2

â‡’ ê°™ì€ Keyë¼ë©´ ì–´ëŠ Producerê°€ ë°œí–‰í•´ë„ ê°™ì€ íŒŒí‹°ì…˜!
â‡’ ìˆœì„œ ë³´ì¥ ìœ ì§€ë¨ âœ…
```

**2. ì²˜ë¦¬ëŸ‰ ë³€í™”:**

```
ë‹¨ì¼ Producer:
- order-eventsë¡œ ì´ˆë‹¹ 1000ê°œ ë©”ì‹œì§€ ë°œí–‰ ê°€ëŠ¥

3ê°œ Producer (Pod):
- ê° Podê°€ ì´ˆë‹¹ 1000ê°œì”© ë°œí–‰ ê°€ëŠ¥
- ì´ 3000ê°œ/ì´ˆ ì²˜ë¦¬ ê°€ëŠ¥
- â‡’ ì²˜ë¦¬ëŸ‰ 3ë°° ì¦ê°€! âš¡
```

**3. íŒŒí‹°ì…˜ ë¶„ì‚°:**

```
3ê°œ Producer, 3ê°œ Partition:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 1      â”‚ â”€â†’ Partition 0 (Key hashì— ë”°ë¼)
â”‚             â”‚ â”€â†’ Partition 1
â”‚             â”‚ â”€â†’ Partition 2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 2      â”‚ â”€â†’ Partition 0 (Key hashì— ë”°ë¼)
â”‚             â”‚ â”€â†’ Partition 1
â”‚             â”‚ â”€â†’ Partition 2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 3      â”‚ â”€â†’ Partition 0 (Key hashì— ë”°ë¼)
â”‚             â”‚ â”€â†’ Partition 1
â”‚             â”‚ â”€â†’ Partition 2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â‡’ ëª¨ë“  Producerê°€ ëª¨ë“  íŒŒí‹°ì…˜ì— ê³ ë¥´ê²Œ ë¶„ì‚° ë°œí–‰
```

**4. ìˆœì„œ ë³´ì¥:**

```
ì£¼ë¬¸ 123ë²ˆì˜ ì´ë²¤íŠ¸ë“¤:

Pod 1: "ORDER_CREATED" (Key: "123") â†’ Partition 1
Pod 2: "PAYMENT_COMPLETED" (Key: "123") â†’ Partition 1 (ê°™ì€ íŒŒí‹°ì…˜!)
Pod 3: "SHIPPED" (Key: "123") â†’ Partition 1 (ê°™ì€ íŒŒí‹°ì…˜!)

â‡’ ê°™ì€ KeyëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ â†’ ìˆœì„œ ë³´ì¥ë¨ âœ…
```

**5. ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤:**

```
ì‹œë‚˜ë¦¬ì˜¤: Pod 1 ì¥ì•  ë°œìƒ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 1 âŒ   â”‚  (ì¥ì• )
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 2 âœ…   â”‚ â”€â†’ ê³„ì† ë©”ì‹œì§€ ë°œí–‰ (ì˜í–¥ ì—†ìŒ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod 3 âœ…   â”‚ â”€â†’ ê³„ì† ë©”ì‹œì§€ ë°œí–‰ (ì˜í–¥ ì—†ìŒ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â‡’ ë‹¤ë¥¸ ProducerëŠ” ì˜í–¥ ì—†ì´ ê³„ì† ë™ì‘
â‡’ ê³ ê°€ìš©ì„± í™•ë³´ âœ…
```

**E-Commerce í”„ë¡œì íŠ¸ ì˜ˆì‹œ:**

```yaml
# Kubernetes Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  replicas: 3  # 3ê°œ Podë¡œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ
  template:
    spec:
      containers:
      - name: order-service
        env:
        - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
          value: "kafka:9092"
```

```java
// ê° PodëŠ” ë™ì¼í•œ Producer ì„¤ì •
@Configuration
public class KafkaProducerConfig {
    @Bean
    public ProducerFactory<String, OrderEvent> producerFactory() {
        Map<String, Object> config = new HashMap<>();
        config.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "kafka:9092");
        config.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        config.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);

        // ë™ì¼ ì„¤ì •ìœ¼ë¡œ ì—¬ëŸ¬ Podê°€ ì‹¤í–‰ë¨
        return new DefaultKafkaProducerFactory<>(config);
    }
}
```

**ì£¼ì˜ì‚¬í•­:**

```
âœ… DO:
- ê°™ì€ ë…¼ë¦¬ì  Key ì‚¬ìš© (ì˜ˆ: orderId)
- ëª¨ë“  Producerì— ë™ì¼í•œ ì§ë ¬í™” ì„¤ì •
- íŒŒí‹°ì…˜ ìˆ˜ë¥¼ Producer ìˆ˜ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ê²Œ ì„¤ì •

âŒ DON'T:
- Producerë§ˆë‹¤ ë‹¤ë¥¸ í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©
- íŒŒí‹°ì…˜ ìˆ˜ë¥¼ ìì£¼ ë³€ê²½ (Key ë¶„ì‚° ê¹¨ì§)
```

**í•µì‹¬:**

```
ì—¬ëŸ¬ Producerê°€ ë™ì‹œ ë°œí–‰í•´ë„:
1. ê°™ì€ KeyëŠ” ê°™ì€ íŒŒí‹°ì…˜ â†’ ìˆœì„œ ë³´ì¥ âœ…
2. ë©”ì‹œì§€ëŠ” ëª¨ë“  íŒŒí‹°ì…˜ì— ê³ ë¥´ê²Œ ë¶„ì‚° âœ…
3. Producer ì¥ì• ëŠ” ë‹¤ë¥¸ Producerì— ì˜í–¥ ì—†ìŒ âœ…
4. ì²˜ë¦¬ëŸ‰ì€ Producer ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ì¦ê°€ âš¡
```

---

## 4. ë©”ì‹œì§€ Keyì™€ íŒŒí‹°ì…”ë‹

### 4.1 ë©”ì‹œì§€ Keyë€?

**ì •ì˜:** ë©”ì‹œì§€ë¥¼ ë¶„ë¥˜í•˜ê³  íŒŒí‹°ì…˜ì„ ê²°ì •í•˜ëŠ” ì‹ë³„ì.

**E-Commerce ì˜ˆì‹œ:**
```java
// orderIdë¥¼ Keyë¡œ ì‚¬ìš©
kafkaTemplate.send(
    "order-events",           // Topic
    order.getOrderId().toString(),  // Key â† ì´ê²ƒ!
    orderEvent                      // Value
);
```

### 4.2 Keyì˜ ì—­í• 

#### 1) ìˆœì„œ ë³´ì¥
**ê°™ì€ Keyë¥¼ ê°€ì§„ ë©”ì‹œì§€ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜**ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.

```
ì£¼ë¬¸ 123ë²ˆì˜ ì´ë²¤íŠ¸ë“¤:
- ì£¼ë¬¸ ìƒì„± (Key: "123") â†’ Partition 1
- ê²°ì œ ì™„ë£Œ (Key: "123") â†’ Partition 1  (ê°™ì€ íŒŒí‹°ì…˜)
- ë°°ì†¡ ì‹œì‘ (Key: "123") â†’ Partition 1  (ê°™ì€ íŒŒí‹°ì…˜)

â‡’ ìˆœì„œ ë³´ì¥ë¨!
```

**ì™œ ì¤‘ìš”í•œê°€?**
```java
// ì˜ëª»ëœ ìˆœì„œë¡œ ì²˜ë¦¬ë˜ë©´ ë¬¸ì œ ë°œìƒ
ì‹œê°„ìˆœ: 1. ì£¼ë¬¸ ìƒì„± â†’ 2. ê²°ì œ ì™„ë£Œ â†’ 3. ì£¼ë¬¸ ì·¨ì†Œ

ë§Œì•½ Consumerê°€ ë‹¤ë¥¸ ìˆœì„œë¡œ ë°›ìœ¼ë©´?
ë°›ì€ ìˆœì„œ: 1. ì£¼ë¬¸ ì·¨ì†Œ â†’ 2. ì£¼ë¬¸ ìƒì„± â†’ 3. ê²°ì œ ì™„ë£Œ
â‡’ ì·¨ì†Œëœ ì£¼ë¬¸ì´ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ë¨! (ë²„ê·¸)
```

#### 2) íŒŒí‹°ì…˜ ë¶„ì‚°
**íŒŒí‹°ì…˜ ê²°ì • ë¡œì§:**
```java
// Kafka ë‚´ë¶€ ë¡œì§ (ê°œë…ì )
int partition = hash(key) % numberOfPartitions;

// ì˜ˆì‹œ
hash("order-123") % 3 = 1  â†’ Partition 1
hash("order-456") % 3 = 0  â†’ Partition 0
hash("order-789") % 3 = 2  â†’ Partition 2
```

### 4.3 Key ì„ íƒ ì „ëµ

#### E-Commerce ì£¼ë¬¸ ì‹œìŠ¤í…œ
```java
// âœ… ê¶Œì¥: orderIdë¥¼ Keyë¡œ ì‚¬ìš©
kafkaTemplate.send("order-events", order.getId().toString(), event);

// ì´ìœ :
// 1. ë™ì¼ ì£¼ë¬¸ì˜ ì´ë²¤íŠ¸ë“¤ì´ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬ë¨
// 2. ì£¼ë¬¸ë³„ë¡œ ê³ ë¥´ê²Œ ë¶„ì‚°ë¨
```

#### Key ì—†ì´ ì „ì†¡í•˜ë©´?
```java
// âŒ Key ì—†ìŒ
kafkaTemplate.send("order-events", null, event);

// ê²°ê³¼: Sticky Partitioner ë°©ì‹ìœ¼ë¡œ íŒŒí‹°ì…˜ í• ë‹¹
// - ë°°ì¹˜ ë‹¨ìœ„ë¡œ í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ì— ë©”ì‹œì§€ë¥¼ ëª¨ì•„ì„œ ì „ì†¡
// - ë°°ì¹˜ê°€ ê°€ë“ ì°¨ê±°ë‚˜ linger.ms ì´ˆê³¼ ì‹œ ë‹¤ìŒ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „í™˜
// - Producer ë°°ì¹˜ ì„¤ì •(batch.size, linger.ms)ì— ì˜í–¥ë°›ìŒ
//
// ë¬¸ì œ: ê°™ì€ ì£¼ë¬¸ì˜ ì´ë²¤íŠ¸ê°€ ë‹¤ë¥¸ íŒŒí‹°ì…˜ì— ë¶„ì‚°ë˜ì–´ ìˆœì„œ ë³´ì¥ ì•ˆ ë¨
//
// ğŸ’¡ ì°¸ê³ : Kafka 2.4+ ê¸°ë³¸ê°’ (ì´ì „ ë²„ì „ì€ round-robin)
```

---

## 5. Consumer Groupê³¼ ë³‘ë ¬ ì²˜ë¦¬

### 5.1 ë³‘ë ¬ ì²˜ë¦¬ ì›ë¦¬

**í•µì‹¬ ê·œì¹™:**
í•˜ë‚˜ì˜ íŒŒí‹°ì…˜ì€ ê°™ì€ Consumer Group ë‚´ì—ì„œ **ë‹¨ í•˜ë‚˜ì˜ Consumerë§Œ** í• ë‹¹ë©ë‹ˆë‹¤.

### 5.2 ì‹œë‚˜ë¦¬ì˜¤ë³„ ì²˜ë¦¬ ë°©ì‹

#### ì‹œë‚˜ë¦¬ì˜¤ 1: Consumer < Partition (ì´ìƒì )
```
order-events í† í”½ (3ê°œ íŒŒí‹°ì…˜)
Consumer Group: notification-group (2ê°œ Consumer)

Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer A  (í•˜ë‚˜ì˜ Consumerê°€ 2ê°œ íŒŒí‹°ì…˜ ë‹´ë‹¹)
Partition 2 â†’ Consumer B

ì²˜ë¦¬ëŸ‰: 2ë°° ë³‘ë ¬ ì²˜ë¦¬
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: Consumer = Partition (ìµœì )
```
order-events í† í”½ (3ê°œ íŒŒí‹°ì…˜)
Consumer Group: notification-group (3ê°œ Consumer)

Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer B
Partition 2 â†’ Consumer C

ì²˜ë¦¬ëŸ‰: 3ë°° ë³‘ë ¬ ì²˜ë¦¬ (ìµœëŒ€ íš¨ìœ¨)
```

#### ì‹œë‚˜ë¦¬ì˜¤ 3: Consumer > Partition (ë¹„íš¨ìœ¨)
```
order-events í† í”½ (3ê°œ íŒŒí‹°ì…˜)
Consumer Group: notification-group (5ê°œ Consumer)

Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer B
Partition 2 â†’ Consumer C
(ì—†ìŒ)     â†’ Consumer D (ìœ íœ´ ìƒíƒœ)
(ì—†ìŒ)     â†’ Consumer E (ìœ íœ´ ìƒíƒœ)

ì²˜ë¦¬ëŸ‰: 3ë°°ë§Œ ê°€ëŠ¥ (D, EëŠ” ë†€ê³  ìˆìŒ)
â‡’ Consumerë¥¼ ëŠ˜ë ¤ë„ íŒŒí‹°ì…˜ ìˆ˜ ì´ìƒì€ íš¨ê³¼ ì—†ìŒ!
```

### 5.3 ì‹¤ë¬´ ì„¤ì • ì˜ˆì‹œ

```yaml
# application.yml
spring:
  kafka:
    consumer:
      group-id: order-processor-group
      # ë™ì‹œ ì²˜ë¦¬ Consumer ìˆ˜
      concurrency: 3  # íŒŒí‹°ì…˜ ìˆ˜ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
```

```java
// Kubernetes Pod ìŠ¤ì¼€ì¼ë§
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-consumer
spec:
  replicas: 3  # order-events í† í”½ì´ 3ê°œ íŒŒí‹°ì…˜ì´ë©´ 3ê°œ Pod
```

### 5.4 Consumer Rebalancing

**ì •ì˜:** Consumerê°€ ì¶”ê°€/ì œê±°ë  ë•Œ íŒŒí‹°ì…˜ ì¬í• ë‹¹.

**ì˜ˆì‹œ:**
```
ì´ˆê¸° ìƒíƒœ:
Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer B

Consumer C ì¶”ê°€ë¨!

Rebalancing í›„:
Partition 0 â†’ Consumer A
Partition 1 â†’ Consumer C  (ì¬í• ë‹¹)
Partition 2 â†’ Consumer B
```

**Rebalancing ì‹œ ì£¼ì˜ì‚¬í•­:**
- ì§§ì€ ì‹œê°„ ë™ì•ˆ ë©”ì‹œì§€ ì²˜ë¦¬ê°€ ì¤‘ë‹¨ë¨
- ë„ˆë¬´ ìì£¼ ë°œìƒí•˜ì§€ ì•Šë„ë¡ Consumer ìˆ˜ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€

---

## 6. ë©”ì‹œì§€ ì „ë‹¬ ë³´ì¥ ìˆ˜ì¤€

### 6.1 ì„¸ ê°€ì§€ ë³´ì¥ ìˆ˜ì¤€

#### At-most-once (ìµœëŒ€ í•œ ë²ˆ)
**íŠ¹ì§•:** ë©”ì‹œì§€ê°€ **ì†ì‹¤ë  ìˆ˜ ìˆì§€ë§Œ ì¤‘ë³µ ì—†ìŒ**.

**ë™ì‘:**
```
Producer â†’ Kafka (ì „ì†¡ í›„ ì‘ë‹µ í™•ì¸ ì•ˆ í•¨)
Consumer â†’ ë©”ì‹œì§€ ì½ìë§ˆì Offset ì»¤ë°‹
```

**E-Commerce ì˜ˆì‹œ:**
```java
// ì‚¬ìš© ì‚¬ë¡€: ì‹¤ì‹œê°„ ì¡°íšŒìˆ˜, ë¡œê·¸ ìˆ˜ì§‘
@KafkaListener(topics = "page-view-events")
public void trackPageView(PageViewEvent event) {
    // ì¼ë¶€ ì¡°íšŒìˆ˜ ëˆ„ë½ë˜ì–´ë„ í° ë¬¸ì œ ì—†ìŒ
    analyticsService.incrementViewCount(event.getProductId());
}
```

**ì¥ì :** ë¹ ë¦„, ê°„ë‹¨
**ë‹¨ì :** ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œ ë©”ì‹œì§€ ì†ì‹¤ ê°€ëŠ¥

---

#### At-least-once (ìµœì†Œ í•œ ë²ˆ) â­ **ëŒ€ë¶€ë¶„ ì‚¬ìš©**
**íŠ¹ì§•:** ë©”ì‹œì§€ê°€ **ì¤‘ë³µë  ìˆ˜ ìˆì§€ë§Œ ì†ì‹¤ ì—†ìŒ**.

**ë™ì‘:**
```
Producer â†’ Kafka (ì „ì†¡ ì„±ê³µ í™•ì¸)
Consumer â†’ ë©”ì‹œì§€ ì²˜ë¦¬ ì™„ë£Œ í›„ Offset ì»¤ë°‹
```

**E-Commerce ì˜ˆì‹œ:**
```java
// ì‚¬ìš© ì‚¬ë¡€: ì£¼ë¬¸ ì´ë²¤íŠ¸, ê²°ì œ ì´ë²¤íŠ¸
@KafkaListener(topics = "order-events")
public void processOrder(OrderEvent event, Acknowledgment ack) {
    try {
        // ì£¼ë¬¸ ì²˜ë¦¬
        orderService.process(event);

        // ì„±ê³µ í›„ Offset ì»¤ë°‹
        ack.acknowledge();
    } catch (Exception e) {
        // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ (ì¤‘ë³µ ì²˜ë¦¬ ê°€ëŠ¥)
        log.error("ì£¼ë¬¸ ì²˜ë¦¬ ì‹¤íŒ¨, ì¬ì‹œë„ ì˜ˆì •", e);
    }
}
```

**ì„¤ì •:**
```yaml
spring:
  kafka:
    producer:
      acks: all  # ëª¨ë“  ë³µì œë³¸ì— ì €ì¥ í™•ì¸
    consumer:
      enable-auto-commit: false  # ìˆ˜ë™ ì»¤ë°‹
```

**ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€:**
```java
// ë©±ë“±ì„± ë³´ì¥ (ê°™ì€ ë©”ì‹œì§€ ì—¬ëŸ¬ ë²ˆ ì²˜ë¦¬í•´ë„ ê²°ê³¼ ë™ì¼)
@Transactional
public void processOrder(OrderEvent event) {
    // ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ì¸ì§€ í™•ì¸
    if (orderRepository.existsByOrderId(event.getOrderId())) {
        log.info("ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸: {}", event.getOrderId());
        return;  // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
    }

    // ì£¼ë¬¸ ì²˜ë¦¬
    orderRepository.save(new Order(event));
}
```

**ì¥ì :** ë©”ì‹œì§€ ì†ì‹¤ ì—†ìŒ (ì•ˆì „)
**ë‹¨ì :** ì¤‘ë³µ ì²˜ë¦¬ ê°€ëŠ¥ (ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë©±ë“±ì„± ë³´ì¥ í•„ìš”)

---

#### Exactly-once (ì •í™•íˆ í•œ ë²ˆ)
**íŠ¹ì§•:** ë©”ì‹œì§€ê°€ **ì •í™•íˆ í•œ ë²ˆë§Œ** ì²˜ë¦¬ë¨ (ì´ìƒì ).

**ë™ì‘:**
```
Kafka Transactions ì‚¬ìš©
Producer â†’ Kafka (íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì „ì†¡)
Consumer â†’ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì²˜ë¦¬ ë° Offset ì»¤ë°‹
```

**E-Commerce ì˜ˆì‹œ:**
```java
// ì‚¬ìš© ì‚¬ë¡€: ê²°ì œ ê¸ˆì•¡ ì •ì‚°, ì¬ê³  ì°¨ê°
@Transactional
@KafkaListener(topics = "payment-events")
public void processPayment(PaymentEvent event) {
    // Kafka íŠ¸ëœì­ì…˜ + DB íŠ¸ëœì­ì…˜ ê²°í•©
    paymentService.confirmPayment(event.getPaymentId());
    inventoryService.deductStock(event.getOrderItems());

    // ëª¨ë‘ ì„±ê³µí•˜ë©´ Offset ì»¤ë°‹, í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ë¡¤ë°±
}
```

**ì„¤ì •:**
```yaml
spring:
  kafka:
    producer:
      transaction-id-prefix: tx-
    consumer:
      isolation-level: read_committed
```

**ì¥ì :** ì™„ë²½í•œ ë©”ì‹œì§€ ì²˜ë¦¬ ë³´ì¥
**ë‹¨ì :** ì„±ëŠ¥ ì˜¤ë²„í—¤ë“œ, ë³µì¡í•œ ì„¤ì •

---

### 6.2 ì‹¤ë¬´ ì„ íƒ ê°€ì´ë“œ

| ì‹œë‚˜ë¦¬ì˜¤ | ê¶Œì¥ ìˆ˜ì¤€ | ì´ìœ  |
|---------|---------|------|
| ì¡°íšŒìˆ˜, ë¡œê·¸ | At-most-once | ì¼ë¶€ ì†ì‹¤ í—ˆìš©, ì„±ëŠ¥ ìš°ì„  |
| ì£¼ë¬¸ ì•Œë¦¼ | At-least-once | ì¤‘ë³µ ì•Œë¦¼ í—ˆìš©, ì†ì‹¤ ë°©ì§€ |
| ê²°ì œ, ì •ì‚° | Exactly-once | ê¸ˆì•¡ ì •í™•ì„± í•„ìˆ˜ |
| ì¬ê³  ì°¨ê° | At-least-once + ë©±ë“±ì„± | ì‹¤ìš©ì ì¸ ì ˆì¶©ì•ˆ |

**E-Commerce í”„ë¡œì íŠ¸ ê¸°ë³¸ ì„¤ì •:**
```yaml
# ì•ˆì „í•˜ê³  ì‹¤ìš©ì ì¸ At-least-once
spring:
  kafka:
    producer:
      acks: all
      retries: 3
    consumer:
      enable-auto-commit: false
      auto-offset-reset: earliest
```

---

## 7. KRaft ëª¨ë“œ - Controller ì¤‘ì‹¬ ë©”íƒ€ë°ì´í„° ê´€ë¦¬

### 7.1 KRaftë€?

**ì •ì˜:** KRaft (Kafka Raft)ëŠ” Kafkaê°€ ìì²´ì ìœ¼ë¡œ ë©”íƒ€ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ, **Controller ë…¸ë“œ**ê°€ í´ëŸ¬ìŠ¤í„° ìƒíƒœë¥¼ ì§ì ‘ ê´€ë¦¬í•©ë‹ˆë‹¤.

**í•µì‹¬ ê°œë…:**
```
KRaft ì´ì „: Kafka Broker + ì™¸ë¶€ ì‹œìŠ¤í…œ (ë³µì¡í•¨)
KRaft ë°©ì‹: Kafka Broker + ë‚´ì¥ Controller (ë‹¨ìˆœí•¨)
```

**ì™œ KRaftë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?**

1. **ìš´ì˜ ë‹¨ìˆœí™”**: ë³„ë„ ì‹œìŠ¤í…œ ê´€ë¦¬ ë¶ˆí•„ìš”
2. **ì„±ëŠ¥ í–¥ìƒ**: ë©”íƒ€ë°ì´í„° ì ‘ê·¼ ì†ë„ ê°œì„ 
3. **ì•ˆì •ì„± ì¦ê°€**: ì‹œìŠ¤í…œ ë³µì¡ë„ ê°ì†Œë¡œ ì¥ì•  í¬ì¸íŠ¸ ì¶•ì†Œ
4. **í™•ì¥ì„±**: ëŒ€ê·œëª¨ íŒŒí‹°ì…˜ ê´€ë¦¬ ì„±ëŠ¥ í–¥ìƒ

---

### 7.2 KRaft Controller ì—­í• 

**Controllerë€?**

Kafka í´ëŸ¬ìŠ¤í„°ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ëŠ” íŠ¹ìˆ˜í•œ ë…¸ë“œì…ë‹ˆë‹¤. ë¸Œë¡œì»¤ì™€ ë™ì¼í•œ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‹¤í–‰ë˜ì§€ë§Œ, ê´€ë¦¬ ì—…ë¬´ë¥¼ ì „ë‹´í•©ë‹ˆë‹¤.

**Controller êµ¬ì¡°:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kafka Cluster (KRaft)               â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Broker 1   â”‚  â”‚   Broker 2   â”‚       â”‚
â”‚  â”‚ + Controller â”‚  â”‚ + Controller â”‚       â”‚  Controller ì—­í• ë„ í•¨ê»˜ ìˆ˜í–‰
â”‚  â”‚   (Leader)   â”‚  â”‚  (Follower)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â†“                  â†“                â”‚
â”‚    Raft Consensus ë©”íƒ€ë°ì´í„° ë³µì œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ ControllerëŠ” ì „ìš© ë…¸ë“œê°€ ì•„ë‹Œ, Brokerì™€ í†µí•© ì‹¤í–‰
```

**Controllerì˜ ì£¼ìš” ì±…ì„:**

1. **í† í”½ ë©”íƒ€ë°ì´í„° ê´€ë¦¬**
   ```
   - í† í”½ ìƒì„±/ì‚­ì œ
   - íŒŒí‹°ì…˜ ì„¤ì • (ìˆ˜, ë³µì œ ê³„ìˆ˜)
   - í† í”½ ì„¤ì • ë³€ê²½
   ```

2. **íŒŒí‹°ì…˜ Leader ì„ ì¶œ**
   ```
   Broker 1 ì¥ì•  ê°ì§€
     â†“
   Controllerê°€ ìƒˆë¡œìš´ Leader ì„ ì¶œ
     â†“
   ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì „íŒŒ
     â†“
   Producer/Consumer ìë™ ì¬ì—°ê²°
   ```

3. **ë¸Œë¡œì»¤ ìƒíƒœ ê´€ë¦¬**
   ```
   - ë¸Œë¡œì»¤ ë“±ë¡/ì œê±°
   - ë¸Œë¡œì»¤ ìƒíƒœ ëª¨ë‹ˆí„°ë§
   - í´ëŸ¬ìŠ¤í„° ë©¤ë²„ì‹­ ê´€ë¦¬
   ```

4. **ë©”íƒ€ë°ì´í„° ì¼ê´€ì„± ë³´ì¥**
   ```
   ëª¨ë“  ë©”íƒ€ë°ì´í„° ë³€ê²½ì€ Controllerë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰
     â†“
   Raft ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë³µì œ ë° í•©ì˜
     â†“
   ì „ì²´ í´ëŸ¬ìŠ¤í„°ì— ì¼ê´€ëœ ìƒíƒœ ìœ ì§€
   ```

---

### 7.3 Raft Consensus Algorithm

**Raftë€?**

ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œ ì—¬ëŸ¬ ë…¸ë“œê°€ í•˜ë‚˜ì˜ ë°ì´í„°ì— ëŒ€í•´ í•©ì˜(Consensus)í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤. KRaftëŠ” Raftë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”íƒ€ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

**Raft ë™ì‘ ì›ë¦¬:**

```
3ê°œ Controller (Quorum):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller 1â”‚ â† Leader (ë©”íƒ€ë°ì´í„° ì“°ê¸° ë‹´ë‹¹)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ ë³µì œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller 2â”‚ â† Follower (Leader ë³µì œ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ ë³µì œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller 3â”‚ â† Follower (Leader ë³µì œ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â‡’ ê³¼ë°˜ìˆ˜ (2/3) ë™ì˜ ì‹œ ë³€ê²½ í™•ì •
```

**Leader ì„ ì¶œ ê³¼ì •:**

```
1. ì´ˆê¸° ìƒíƒœ: Controller 1ì´ Leader

2. Leader ì¥ì•  ë°œìƒ:
   Controller 1 âŒ (ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ ë˜ëŠ” ì¥ì• )

3. Followerë“¤ì´ Leader ë¶€ì¬ ê°ì§€:
   Controller 2, 3ì´ í•˜íŠ¸ë¹„íŠ¸ ì¤‘ë‹¨ ì¸ì§€

4. ìƒˆë¡œìš´ ì„ ê±° ì‹œì‘:
   Controller 2: "ë‚˜ë¥¼ Leaderë¡œ íˆ¬í‘œí•´ì£¼ì„¸ìš”!"
   Controller 3: "OK, íˆ¬í‘œí•©ë‹ˆë‹¤"

5. ê³¼ë°˜ìˆ˜ ë“í‘œ:
   Controller 2ê°€ 2/3 (ìì‹  + Controller 3) ë“í‘œ
     â†“
   Controller 2ê°€ ìƒˆë¡œìš´ Leaderë¡œ ì„ ì¶œ

6. ë©”íƒ€ë°ì´í„° ë™ê¸°í™”:
   ìƒˆë¡œìš´ Leaderê°€ ëª¨ë“  Followerì™€ ë™ê¸°í™” í™•ì¸

â±ï¸ ì „ì²´ ì„ ì¶œ ê³¼ì •: ìˆ˜ ì´ˆ ì´ë‚´
```

**Quorum (ì •ì¡±ìˆ˜) ê°œë…:**

```
Quorum = ê³¼ë°˜ìˆ˜ = (ì´ Controller ìˆ˜ / 2) + 1

1ê°œ Controller: Quorum = 1 (ì¥ì•  í—ˆìš© 0)
3ê°œ Controller: Quorum = 2 (ì¥ì•  í—ˆìš© 1) âœ… ê¶Œì¥
5ê°œ Controller: Quorum = 3 (ì¥ì•  í—ˆìš© 2)

âš ï¸ ì™œ í™€ìˆ˜ë¡œ êµ¬ì„±í•˜ëŠ”ê°€?
- 3ê°œ: 1ê°œ ì¥ì•  í—ˆìš© (Quorum 2)
- 4ê°œ: 1ê°œ ì¥ì•  í—ˆìš© (Quorum 3) â† 3ê°œì™€ ë™ì¼í•œ ì¥ì•  í—ˆìš©, ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
- 5ê°œ: 2ê°œ ì¥ì•  í—ˆìš© (Quorum 3) âœ… ë” ë†’ì€ ê°€ìš©ì„±
```

---

### 7.4 ë©”íƒ€ë°ì´í„° ë¡œê·¸ (Metadata Log)

**Metadata Logë€?**

Controllerê°€ ê´€ë¦¬í•˜ëŠ” ëª¨ë“  ë©”íƒ€ë°ì´í„° ë³€ê²½ ì‚¬í•­ì„ ìˆœì°¨ì ìœ¼ë¡œ ê¸°ë¡í•˜ëŠ” ë¡œê·¸ì…ë‹ˆë‹¤.

**ë©”íƒ€ë°ì´í„° ë³€ê²½ íë¦„:**

```
1. í† í”½ ìƒì„± ìš”ì²­:
   kafka-topics.sh --create --topic order-events
     â†“
2. Leader Controllerê°€ ë³€ê²½ ì‚¬í•­ì„ Metadata Logì— ê¸°ë¡:
   Offset 1000: CREATE_TOPIC order-events, partitions=3
     â†“
3. Raft ë³µì œ:
   Leader â†’ Follower Controllerë“¤ì—ê²Œ ë³µì œ
     â†“
4. Quorum í™•ì¸:
   ê³¼ë°˜ìˆ˜ Controllerê°€ ë¡œê·¸ ì €ì¥ ì™„ë£Œ
     â†“
5. ë³€ê²½ í™•ì • ë° ë¸Œë¡œì»¤ ì „íŒŒ:
   ëª¨ë“  ë¸Œë¡œì»¤ì— ìƒˆë¡œìš´ í† í”½ ì •ë³´ ì „ë‹¬
     â†“
6. ì™„ë£Œ:
   order-events í† í”½ ì‚¬ìš© ê°€ëŠ¥
```

**Metadata Log ì˜ˆì‹œ:**

```
Offset | ë©”íƒ€ë°ì´í„° ë³€ê²½ ë‚´ìš©
-------|------------------
1000   | CREATE_TOPIC order-events, partitions=3
1001   | CREATE_PARTITION order-events, partition=3 (íŒŒí‹°ì…˜ ì¦ê°€)
1002   | ELECT_LEADER order-events-0, broker=2 (ë¦¬ë” ì¬ì„ ì¶œ)
1003   | UPDATE_CONFIG order-events, retention.ms=604800000
1004   | DELETE_TOPIC old-events

â‡’ ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ìˆœì°¨ì ìœ¼ë¡œ ê¸°ë¡ë˜ì–´ ì¬í˜„ ê°€ëŠ¥
```

**ì¥ì :**

```
1. ì¥ì•  ë³µêµ¬:
   - Controller ì¬ì‹œì‘ ì‹œ Metadata Log ì¬ìƒ â†’ ìƒíƒœ ë³µì›

2. ì¼ê´€ì„± ë³´ì¥:
   - ëª¨ë“  Controllerê°€ ë™ì¼í•œ ë¡œê·¸ ë³´ìœ  â†’ ë™ì¼í•œ ìƒíƒœ

3. ê°ì‚¬(Audit):
   - ëˆ„ê°€, ì–¸ì œ, ë¬´ì—‡ì„ ë³€ê²½í–ˆëŠ”ì§€ ì¶”ì  ê°€ëŠ¥
```

---

### 7.5 í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì„±

**Docker Compose ì„¤ì •:**

```yaml
# docker-compose.yml
kafka:
  environment:
    # KRaft ëª¨ë“œ í™œì„±í™”
    KAFKA_PROCESS_ROLES: 'broker,controller'  # ë‹¨ì¼ ë…¸ë“œê°€ ë‘ ì—­í•  ìˆ˜í–‰

    # Controller Quorum ì„¤ì •
    KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093'  # Controller ID 1

    # í´ëŸ¬ìŠ¤í„° ID (KRaft í•„ìˆ˜)
    CLUSTER_ID: 'MkU3OEVBNTcwNTJENDM2Qk'

    # Controller ë¦¬ìŠ¤ë„ˆ (ë‚´ë¶€ í†µì‹ ìš©)
    KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
    KAFKA_LISTENERS: 'PLAINTEXT://kafka:9092,CONTROLLER://kafka:9093'
```

**ì„¤ì • ì˜ë¯¸:**

| ì„¤ì • | ì˜ë¯¸ |
|-----|------|
| `KAFKA_PROCESS_ROLES` | ë¸Œë¡œì»¤ + ì»¨íŠ¸ë¡¤ëŸ¬ í†µí•© ì‹¤í–‰ |
| `KAFKA_CONTROLLER_QUORUM_VOTERS` | Controller Quorum ë©¤ë²„ ëª©ë¡ |
| `CLUSTER_ID` | KRaft í´ëŸ¬ìŠ¤í„° ê³ ìœ  ID |
| `CONTROLLER` ë¦¬ìŠ¤ë„ˆ | Controller ê°„ í†µì‹  í¬íŠ¸ (9093) |

**ë¡œì»¬ ê°œë°œ í™˜ê²½ íŠ¹ì§•:**

```
êµ¬ì„±: 1ê°œ ë…¸ë“œ (Broker + Controller í†µí•©)

ì¥ì :
âœ… ê°„ë‹¨í•œ ì„¤ì •
âœ… ë¦¬ì†ŒìŠ¤ ì ˆì•½
âœ… ë¹ ë¥¸ ì‹œì‘

ë‹¨ì :
âš ï¸ ê³ ê°€ìš©ì„± ì—†ìŒ (ì¥ì•  í—ˆìš© 0)
âš ï¸ ë‹¨ì¼ ì¥ì• ì  (Single Point of Failure)

â‡’ ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ì í•©
```

**ìš´ì˜ í™˜ê²½ ê¶Œì¥ êµ¬ì„±:**

```yaml
# 3ê°œ ë…¸ë“œ í´ëŸ¬ìŠ¤í„° (Kubernetes ì˜ˆì‹œ)
kafka-1:
  KAFKA_PROCESS_ROLES: 'broker,controller'
  KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093'
  KAFKA_NODE_ID: 1

kafka-2:
  KAFKA_PROCESS_ROLES: 'broker,controller'
  KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093'
  KAFKA_NODE_ID: 2

kafka-3:
  KAFKA_PROCESS_ROLES: 'broker,controller'
  KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka-1:9093,2@kafka-2:9093,3@kafka-3:9093'
  KAFKA_NODE_ID: 3

â‡’ 3ê°œ Controller Quorum
â‡’ 1ê°œ ì¥ì• ê¹Œì§€ í—ˆìš©
â‡’ ê³ ê°€ìš©ì„± í™•ë³´ âœ…
```

---

### 7.6 KRaft ëª¨ë“œ í•µì‹¬ ìš”ì•½

**KRaft í•µì‹¬ ì•„í‚¤í…ì²˜:**

```
ê¸°ì¡´ ë°©ì‹: Kafka Broker + ì™¸ë¶€ ì˜ì¡´ ì‹œìŠ¤í…œ
                      â†“
                 ê´€ë¦¬ ë³µì¡ë„ ì¦ê°€
                 ì¥ì•  í¬ì¸íŠ¸ ì¶”ê°€
                 ì„±ëŠ¥ ë³‘ëª©

KRaft ë°©ì‹: Kafka (Broker + Controller í†µí•©)
                      â†“
                 ë‹¨ìˆœí•œ ìš´ì˜
                 ë¹ ë¥¸ ë©”íƒ€ë°ì´í„° ì ‘ê·¼
                 í™•ì¥ì„± í–¥ìƒ
```

**í•µì‹¬ êµ¬ì„± ìš”ì†Œ:**

```
1. Controller (ì»¨íŠ¸ë¡¤ëŸ¬)
   - ì—­í• : ë©”íƒ€ë°ì´í„° ê´€ë¦¬, ë¦¬ë” ì„ ì¶œ, í´ëŸ¬ìŠ¤í„° ìƒíƒœ ê´€ë¦¬
   - íŠ¹ì§•: Brokerì™€ í†µí•© ì‹¤í–‰ ê°€ëŠ¥

2. Raft Consensus (í•©ì˜ ì•Œê³ ë¦¬ì¦˜)
   - ì—­í• : ë©”íƒ€ë°ì´í„° ë³µì œ ë° ì¼ê´€ì„± ë³´ì¥
   - ë°©ì‹: Leader-Follower, Quorum ê¸°ë°˜ í•©ì˜

3. Metadata Log (ë©”íƒ€ë°ì´í„° ë¡œê·¸)
   - ì—­í• : ëª¨ë“  ë©”íƒ€ë°ì´í„° ë³€ê²½ ì‚¬í•­ ê¸°ë¡
   - ì¥ì : ì¥ì•  ë³µêµ¬, ì¼ê´€ì„±, ê°ì‚¬ ì¶”ì 
```

**í˜„ì¬ ìƒíƒœ (2024-2025ë…„):**

```
âœ… Kafka 3.3 ì´ìƒ: KRaft Production Ready
âš ï¸ Kafka 4.0 (ì˜ˆì •): ê¸°ì¡´ ë°©ì‹ ì§€ì› ì™„ì „ ì œê±°
ğŸ¯ ê¶Œì¥ ì‚¬í•­: ì‹ ê·œ í”„ë¡œì íŠ¸ëŠ” KRaft ì‚¬ìš©
```

---

## 8. Kafka UI í™œìš©

### 8.1 Kafka UIë€?

**ì •ì˜:** Kafka í´ëŸ¬ìŠ¤í„°ë¥¼ ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì‹œê°ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ë„êµ¬.

**ì ‘ì†:** http://localhost:8080

### 8.2 ì£¼ìš” ê¸°ëŠ¥

#### 1) í† í”½ ê´€ë¦¬
```
Topics ë©”ë‰´:
- í† í”½ ëª©ë¡ ì¡°íšŒ
- í† í”½ ìƒì„±/ì‚­ì œ
- íŒŒí‹°ì…˜ ìˆ˜, ë³µì œ ê³„ìˆ˜ í™•ì¸
- ë©”ì‹œì§€ ì´ëŸ‰ í™•ì¸
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```
1. Topics ë©”ë‰´ í´ë¦­
2. "Create Topic" ë²„íŠ¼
3. í† í”½ ì •ë³´ ì…ë ¥:
   - Name: order-events
   - Partitions: 3
   - Replication Factor: 1
4. ìƒì„± ì™„ë£Œ
```

#### 2) ë©”ì‹œì§€ ì¡°íšŒ
```
Messages íƒ­:
- ì‹¤ì‹œê°„ ë©”ì‹œì§€ í™•ì¸
- ë©”ì‹œì§€ Key, Value ì¡°íšŒ
- íŒŒí‹°ì…˜ë³„ ë©”ì‹œì§€ í™•ì¸
- Offset ìœ„ì¹˜ í™•ì¸
```

**ë””ë²„ê¹… ì‹œë‚˜ë¦¬ì˜¤:**
```
ë¬¸ì œ: ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ê°€ Consumerì— ì „ë‹¬ë˜ì§€ ì•ŠìŒ

Kafka UIì—ì„œ í™•ì¸:
1. order-events í† í”½ ì„ íƒ
2. Messages íƒ­
3. ìµœê·¼ ë©”ì‹œì§€ í™•ì¸
   âœ… ë©”ì‹œì§€ ìˆìŒ â†’ Consumer ë¬¸ì œ
   âŒ ë©”ì‹œì§€ ì—†ìŒ â†’ Producer ë¬¸ì œ
```

#### 3) Consumer Group ëª¨ë‹ˆí„°ë§
```
Consumers ë©”ë‰´:
- Consumer Group ëª©ë¡
- ê° ê·¸ë£¹ì˜ Lag (ì²˜ë¦¬ ì§€ì—°) í™•ì¸
- íŒŒí‹°ì…˜ë³„ Offset ìœ„ì¹˜
- Consumer ì—°ê²° ìƒíƒœ
```

**Lag í™•ì¸:**
```
Consumer Group: notification-service-group

Partition 0:
  Current Offset: 1000
  End Offset: 1500
  Lag: 500 â† ì²˜ë¦¬ ì§€ì—° 500ê°œ ë©”ì‹œì§€

â‡’ Consumer ì„±ëŠ¥ ë¬¸ì œ ë˜ëŠ” ì¥ì•  ì˜ì‹¬
```

#### 4) ë¸Œë¡œì»¤ ìƒíƒœ
```
Brokers ë©”ë‰´:
- ë¸Œë¡œì»¤ ëª©ë¡
- ë¦¬ë” íŒŒí‹°ì…˜ ë¶„í¬
- ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
- ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½
```

### 8.3 ì‹¤ë¬´ í™œìš© ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ë©”ì‹œì§€ ìˆ˜ë™ ë°œí–‰ (í…ŒìŠ¤íŠ¸)
```
1. Kafka UI â†’ Topics â†’ order-events
2. "Produce Message" ë²„íŠ¼
3. Key: "test-order-123"
4. Value (JSON):
   {
     "orderId": 123,
     "userId": 1,
     "eventType": "ORDER_CREATED"
   }
5. Send
6. Consumer ë¡œê·¸ í™•ì¸ â†’ ë©”ì‹œì§€ ì²˜ë¦¬ í™•ì¸
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: Consumer Lag ëª¨ë‹ˆí„°ë§
```
ì •ê¸°ì ìœ¼ë¡œ í™•ì¸:
- Lag > 1000 â†’ Consumer ìŠ¤ì¼€ì¼ ì•„ì›ƒ ê³ ë ¤
- Lag ê³„ì† ì¦ê°€ â†’ Consumer ì¥ì•  ë˜ëŠ” ì²˜ë¦¬ ì„±ëŠ¥ ë¬¸ì œ
```

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ë©”ì‹œì§€ ìˆœì„œ ê²€ì¦
```
ì£¼ë¬¸ ID "123"ì˜ ì´ë²¤íŠ¸ ìˆœì„œ í™•ì¸:
1. Messages íƒ­
2. Key Filter: "123"
3. ì‹œê°„ìˆœ ì •ë ¬
4. ìˆœì„œ í™•ì¸:
   âœ… ORDER_CREATED â†’ PAYMENT_COMPLETED â†’ SHIPPED (ì •ìƒ)
   âŒ PAYMENT_COMPLETED â†’ ORDER_CREATED (ë¹„ì •ìƒ)
```

---

## 9. ì‹¤ë¬´ ì ìš© ì‹œë‚˜ë¦¬ì˜¤

### 9.1 ì£¼ë¬¸ ìƒì„± ì´ë²¤íŠ¸ ë°œí–‰

**ìš”êµ¬ì‚¬í•­:**
ì£¼ë¬¸ì´ ìƒì„±ë˜ë©´ ì•Œë¦¼ ì„œë¹„ìŠ¤, ì¬ê³  ì„œë¹„ìŠ¤, ë¶„ì„ ì„œë¹„ìŠ¤ì— ì•Œë ¤ì•¼ í•¨.

**êµ¬í˜„:**
```java
@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;
    private final KafkaTemplate<String, OrderEvent> kafkaTemplate;

    @Transactional
    public Order createOrder(CreateOrderRequest request) {
        // 1. ì£¼ë¬¸ ì €ì¥ (DB)
        Order order = Order.builder()
            .userId(request.getUserId())
            .orderItems(request.getOrderItems())
            .totalAmount(request.getTotalAmount())
            .status(OrderStatus.PENDING)
            .build();
        orderRepository.save(order);

        // 2. ì´ë²¤íŠ¸ ë°œí–‰ (Kafka)
        OrderEvent event = OrderEvent.builder()
            .orderId(order.getOrderId())
            .userId(order.getUserId())
            .orderItems(order.getOrderItems())
            .eventType("ORDER_CREATED")
            .timestamp(LocalDateTime.now())
            .build();

        kafkaTemplate.send(
            "order-events",                    // Topic
            order.getOrderId().toString(),     // Key (ìˆœì„œ ë³´ì¥)
            event                              // Value
        );

        return order;
    }
}
```

**í† í”½ êµ¬ì„±:**
```yaml
order-events:
  partitions: 5
  replication-factor: 1  # ë¡œì»¬ í™˜ê²½
  retention.ms: 604800000  # 7ì¼ ë³´ê´€
```

---

### 9.2 ì•Œë¦¼ ì„œë¹„ìŠ¤ (Consumer)

```java
@Service
@Slf4j
public class NotificationConsumer {

    @KafkaListener(
        topics = "order-events",
        groupId = "notification-service-group",
        concurrency = "3"  // 3ê°œ íŒŒí‹°ì…˜ì— ë§ì¶° 3ê°œ Consumer
    )
    public void handleOrderEvent(
        @Payload OrderEvent event,
        @Header(KafkaHeaders.RECEIVED_PARTITION_ID) int partition,
        Acknowledgment ack
    ) {
        try {
            log.info("ì£¼ë¬¸ ì´ë²¤íŠ¸ ìˆ˜ì‹  - orderId: {}, partition: {}",
                    event.getOrderId(), partition);

            // ì£¼ë¬¸ ì™„ë£Œ ì•Œë¦¼ ë°œì†¡
            if ("ORDER_CREATED".equals(event.getEventType())) {
                sendNotification(event.getUserId(),
                    "ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸: " + event.getOrderId());
            }

            // ìˆ˜ë™ Offset ì»¤ë°‹
            ack.acknowledge();

        } catch (Exception e) {
            log.error("ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨ - orderId: {}", event.getOrderId(), e);
            // ì¬ì‹œë„ ë¡œì§ ë˜ëŠ” DLQ(Dead Letter Queue) ì²˜ë¦¬
        }
    }

    private void sendNotification(Long userId, String message) {
        // ì‹¤ì œ ì•Œë¦¼ ë°œì†¡ ë¡œì§
        // - í‘¸ì‹œ ì•Œë¦¼
        // - ì´ë©”ì¼
        // - SMS
    }
}
```

---

### 9.3 ì¬ê³  ì„œë¹„ìŠ¤ (Consumer)

```java
@Service
@Slf4j
public class InventoryConsumer {

    @Autowired
    private InventoryService inventoryService;

    @KafkaListener(
        topics = "order-events",
        groupId = "inventory-service-group"
    )
    public void handleOrderEvent(OrderEvent event, Acknowledgment ack) {
        try {
            if ("ORDER_CREATED".equals(event.getEventType())) {
                // ì¬ê³  ì°¨ê°
                for (OrderItem item : event.getOrderItems()) {
                    inventoryService.deductStock(
                        item.getProductId(),
                        item.getQuantity()
                    );
                }
                log.info("ì¬ê³  ì°¨ê° ì™„ë£Œ - orderId: {}", event.getOrderId());
            }

            ack.acknowledge();

        } catch (InsufficientStockException e) {
            log.error("ì¬ê³  ë¶€ì¡± - orderId: {}", event.getOrderId());
            // ì£¼ë¬¸ ì·¨ì†Œ ì´ë²¤íŠ¸ ë°œí–‰
            publishOrderCancelled(event.getOrderId(), "ì¬ê³  ë¶€ì¡±");
        }
    }
}
```

---

### 9.4 ë¶„ì„ ì„œë¹„ìŠ¤ (Consumer)

```java
@Service
@Slf4j
public class AnalyticsConsumer {

    @KafkaListener(
        topics = "order-events",
        groupId = "analytics-service-group"
    )
    public void handleOrderEvent(OrderEvent event, Acknowledgment ack) {
        try {
            // ì£¼ë¬¸ í†µê³„ ìˆ˜ì§‘
            analyticsRepository.save(
                OrderAnalytics.builder()
                    .orderId(event.getOrderId())
                    .userId(event.getUserId())
                    .totalAmount(event.getTotalAmount())
                    .orderDate(event.getTimestamp())
                    .build()
            );

            // Elasticsearch ì¸ë±ì‹± (ì„ íƒ)
            elasticsearchService.indexOrder(event);

            ack.acknowledge();

        } catch (Exception e) {
            log.error("ë¶„ì„ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨ - orderId: {}", event.getOrderId(), e);
            // ë¶„ì„ ë°ì´í„°ëŠ” ì¤‘ìš”ë„ê°€ ë‚®ìœ¼ë¯€ë¡œ ì‹¤íŒ¨í•´ë„ Ack
            ack.acknowledge();
        }
    }
}
```

---

### 9.5 ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì£¼ë¬¸ ì„œë¹„ìŠ¤   â”‚ (Producer)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ OrderEvent ë°œí–‰
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kafka (order-events)      â”‚
â”‚   - Partition 0             â”‚
â”‚   - Partition 1             â”‚
â”‚   - Partition 2             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â†’ ì•Œë¦¼ ì„œë¹„ìŠ¤ (notification-service-group)
         â”‚       â†“
         â”‚     í‘¸ì‹œ ì•Œë¦¼ / ì´ë©”ì¼ / SMS
         â”‚
         â”œâ”€â”€â”€â”€â†’ ì¬ê³  ì„œë¹„ìŠ¤ (inventory-service-group)
         â”‚       â†“
         â”‚     ì¬ê³  ì°¨ê° / ì¬ê³  ë¶€ì¡± ì‹œ ì£¼ë¬¸ ì·¨ì†Œ
         â”‚
         â””â”€â”€â”€â”€â†’ ë¶„ì„ ì„œë¹„ìŠ¤ (analytics-service-group)
                 â†“
               ì£¼ë¬¸ í†µê³„ / ë§¤ì¶œ ë¶„ì„ / Elasticsearch
```

---

## ìš”ì•½

### Kafka í•µì‹¬ ê°œë… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **Broker**: Kafka ì„œë²„, ë©”ì‹œì§€ ì €ì¥ ë° ì „ë‹¬
- [ ] **Topic**: ë©”ì‹œì§€ ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ (order-events, payment-events ë“±)
- [ ] **Partition**: í† í”½ì˜ ë¬¼ë¦¬ì  ë¶„í• , ë³‘ë ¬ ì²˜ë¦¬ ë‹¨ìœ„
- [ ] **Producer**: ë©”ì‹œì§€ë¥¼ Kafkaì— ë°œí–‰í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜
- [ ] **Consumer**: Kafkaì—ì„œ ë©”ì‹œì§€ë¥¼ ì½ì–´ê°€ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜
- [ ] **Consumer Group**: ê°™ì€ í† í”½ì„ êµ¬ë…í•˜ëŠ” Consumer ê·¸ë£¹
- [ ] **Offset**: íŒŒí‹°ì…˜ ë‚´ ë©”ì‹œì§€ì˜ ìˆœì°¨ ìœ„ì¹˜
- [ ] **Message Key**: íŒŒí‹°ì…˜ ê²°ì • ë° ìˆœì„œ ë³´ì¥ì˜ í•µì‹¬
- [ ] **At-least-once**: ì¤‘ë³µ ê°€ëŠ¥í•˜ì§€ë§Œ ì†ì‹¤ ì—†ëŠ” ë©”ì‹œì§€ ì „ë‹¬ (ì‹¤ë¬´ ê¸°ë³¸)
- [ ] **KRaft ëª¨ë“œ**: Controller ê¸°ë°˜ ë©”íƒ€ë°ì´í„° ê´€ë¦¬ (í˜„ì¬ í”„ë¡œì íŠ¸ êµ¬ì„±)
- [ ] **Kafka UI**: ì›¹ ê¸°ë°˜ Kafka ê´€ë¦¬ ë„êµ¬

### E-Commerce í”„ë¡œì íŠ¸ ì ìš© í¬ì¸íŠ¸

1. **ì£¼ë¬¸ ì´ë²¤íŠ¸**: orderIdë¥¼ Keyë¡œ ì‚¬ìš©í•˜ì—¬ ìˆœì„œ ë³´ì¥
2. **ì„œë¹„ìŠ¤ë³„ ë…ë¦½ ì²˜ë¦¬**: ê° ì„œë¹„ìŠ¤ê°€ ë…ë¦½ì ì¸ Consumer Group
3. **At-least-once + ë©±ë“±ì„±**: ì•ˆì „í•˜ê³  ì‹¤ìš©ì ì¸ ë©”ì‹œì§€ ì²˜ë¦¬
4. **íŒŒí‹°ì…˜ = Consumer**: ìµœì ì˜ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•œ 1:1 ë§¤ì¹­
5. **Kafka UI í™œìš©**: ê°œë°œ ë° ë””ë²„ê¹… ì‹œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

---

**ì°¸ê³  ìë£Œ:**
- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)
- [Spring Kafka Documentation](https://spring.io/projects/spring-kafka)
- [Kafka UI GitHub](https://github.com/provectus/kafka-ui)
