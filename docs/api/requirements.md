# E-Commerce 플랫폼 요구사항 명세서

## 1. 이해관계자 요구사항

### 고객 (사용자)
- 상품 정보를 빠르게 조회하고 구매 결정을 내릴 수 있어야 함
- 장바구니에서 유연하게 상품을 관리할 수 있어야 함
- 안전한 결제 프로세스를 통해 신뢰감 있게 구매할 수 있어야 함
- 쿠폰 할인을 적용받아 비용을 절감할 수 있어야 함
- 인기 상품 정보를 참고하여 구매 결정을 내릴 수 있어야 함

---

## 2. 기능적 요구사항

### 2.1 상품 관리 (Product Management)

#### 요구사항 2.1.1: 상품 정보 조회
- **기능**: 사용자 및 주문 시스템이 상품 정보를 조회할 수 있어야 함
- **조회 정보**:
  - 상품명 (Product Name)
  - 가격 (Price)
  - 재고 수량 (Stock Quantity)
  - 상품 상태 (Status: 판매 중 / 품절)
  - 옵션 (Color, Size)
- **비고**: 읽기 빈도가 높으므로 캐싱 고려 가능 (현재 단순 조회 기준)

#### 요구사항 2.1.2: 재고 실시간 확인 및 동시성 제어
- **기능**: 주문 시점에 재고 정보가 정확해야 함
- **검증 조건**:
  - 재고는 음수가 되지 않아야 함
  - `재고 수량 >= 주문 수량` 조건 검증 필수
  - 동시 주문에 대한 동시성 제어 필수 (Race Condition 방지)

#### 요구사항 2.1.3: 인기 상품 통계
- **기능**: 최근 3일간의 인기 상품 정보 제공
- **상세 조건**:
  - 기준: 최근 3일간 주문량, 조회 수, 또는 판매량
  - 상위 5개 상품만 조회 반환 (Top 5)
  - 조회 시 실시간 계산 가능 (배치/캐시 방식은 추가 요구 아님)

#### 요구사항 2.1.4: 상품 옵션 관리 (Product Option Management)
- **기능**: 상품의 다양한 옵션(사이즈, 색상, 저장공간 등)을 관리하고 각 옵션별 재고를 독립적으로 관리
- **옵션 구조**:
  - 각 상품은 다중 옵션을 가질 수 있음 (예: 티셔츠의 "검은색/M", "흰색/L" 등)
  - 각 옵션은 고유한 옵션 ID를 가짐
  - 각 옵션은 독립적인 재고 수량을 유지
- **상세 조건**:
  - 옵션 조회 정보:
    - 옵션 ID (Option ID)
    - 옵션명 (Option Name) - 예: "블랙 / M", "화이트 / L"
    - 옵션별 재고 수량 (Option Stock Quantity)
  - 상품 총 재고 = 모든 옵션의 재고 합계 (일관성 유지)
  - 옵션 레벨의 재고는 음수가 될 수 없음 (재고 >= 0)

- **장바구니 및 주문 생성 시 옵션 처리**:
  - 사용자는 장바구니에 상품을 추가할 때 **반드시 옵션을 선택**해야 함
  - 장바구니 아이템 구조: 상품 ID + 옵션 ID + 수량
  - 주문 생성 시에도 상품 ID와 함께 옵션 ID를 기록
  - 같은 상품이라도 다른 옵션은 장바구니에서 별도 아이템으로 취급

- **재고 검증 및 차감 시 옵션 반영**:
  - 재고 충분성 검증: `옵션별 재고 >= 주문 수량` 조건 검증 (상품 총 재고 X)
  - 재고 부족 시: 특정 옵션이 부족함을 명시하여 오류 반환 (예: "블랙 / M의 재고가 부족합니다")
  - 재고 차감: 주문의 옵션 ID를 기반으로 해당 옵션의 재고만 차감
  - 차감 공식: `옵션 재고 = 옵션 재고 - 주문 수량`

- **데이터 일관성 유지**:
  - 모든 옵션의 재고 합계 = 상품 총 재고 (정기적 검증 필요)
  - 옵션 추가/삭제 시 상품 총 재고 자동 업데이트
  - 품절 여부: 모든 옵션의 재고가 0이 되었을 때만 상품 상태를 "품절"로 변경

---

### 2.2 주문 / 결제 시스템 (Order & Payment System)

#### 요구사항 2.2.1: 장바구니 기능
- **기능**: 사용자가 상품을 임시 보관하고 관리할 수 있어야 함
- **상세 조건**:
  - 상품 ID 및 수량 저장
  - 장바구니 내 수량 변경 가능
  - **장바구니는 결제 직전까지 재고에 영향을 주지 않음** (재고 차감 X)

#### 요구사항 2.2.2: 주문 시 재고 확인 및 차감
- **기능**: 주문 요청 시 재고 검증 및 원자적 차감
- **처리 순서**:
  1. 각 상품의 옵션별 재고 조회
  2. 재고 부족 시 주문 실패 처리
  3. 재고 충분 시 **트랜잭션 내에서** 재고 차감 + 주문 생성 (원자성 보장)

#### 요구사항 2.2.3: 잔액 기반 결제
- **기능**: 사용자 계정의 충전 잔액(Balance)으로 결제
- **처리 조건**:
  - 사용자 계정에 충전 잔액 필수
  - 결제 실행 조건: `결제금액 <= 잔액`
  - 결제 성공 시: `balance -= 결제금액` 차감

#### 요구사항 2.2.4: 쿠폰 할인 적용
- **기능**: 주문 결제 시 쿠폰 할인을 적용
- **결제 금액 계산 순서**:
  ```
  (상품 총액 - 쿠폰 할인액) = 결제금액 → 잔액과 비교 후 차감
  ```
- **쿠폰 사용 가능 조건**:
  - 쿠폰 유효기간 내인지 확인
  - 이미 사용한 쿠폰인지 여부 확인
  - 선착순 발급 쿠폰인 경우, 사용자에게 존재하는지 확인

---

### 2.3 쿠폰 시스템 (Coupon System)

#### 요구사항 2.3.1: 선착순 발급 (한정 수량)
- **기능**: 쿠폰을 한정 수량으로 발급하고 관리
- **상세 조건**:
  - 쿠폰 테이블에 `발급 가능 수량` 필드 존재
  - 발급 시 검증: `남은 수량 > 0`
  - **동시 발급 요청에서 수량 초과 방지** (원자적 감소 필수, Race Condition 방지)

#### 요구사항 2.3.2: 쿠폰 유효성 검증
- **기능**: 쿠폰 사용 시점에 다중 조건 검증
- **검증 항목**:
  - 쿠폰이 존재하는가
  - 발급받은 사용자에게 속해 있는가
  - 유효기간 내인가
  - 이미 사용했는지 여부

#### 요구사항 2.3.3: 쿠폰 사용 이력 관리
- **기능**: 쿠폰 사용 시점의 이력 기록
- **상세 조건**:
  - 주문 ID + 사용 시간 기록
  - 쿠폰 상태를 `USED`로 변경

---

### 2.4 데이터 연동 (External System Integration)

#### 요구사항 2.4.1: 주문 데이터 외부 전송
- **기능**: 주문 생성 후 외부 시스템으로 데이터 전달
- **외부 대상 시스템**: 회계 시스템, 배송 시스템 등
- **처리 원칙**:
  - 외부 전송은 주문 처리 트랜잭션과 **분리**되어야 함
  - **외부 전송 실패해도 주문은 완료 상태 유지** (주문 완료와 외부 전송 분리)

#### 요구사항 2.4.2: 외부 전송 실패 시 재시도 및 보관
- **기능**: 외부 전송 실패 시에도 데이터 손실 방지
- **처리 절차**:
  - 외부 전송 실패 데이터 저장 (예: Outbox 패턴)
  - 별도 재처리 메커니즘으로 재전송 시도 (배치 작업 또는 메시지 큐)

---

## 3. 비기능적 요구사항

### 3.1 성능 (Performance)
- 상품 정보 조회 응답 시간: 평균 < 1초 (캐싱 미적용 기준)
- 주문 처리 응답 시간: < 3초
- 인기 상품 조회 응답 시간: < 2초

### 3.2 동시성 (Concurrency)
- 동시 주문 요청에 대해 재고 부정합 방지 (Optimistic Lock)
- 동시 쿠폰 발급 요청에 대해 수량 초과 방지 (원자적 감소)
- 데이터베이스 트랜잭션을 활용한 원자성 보장

### 3.3 안정성 (Reliability)
- 주문-재고 처리의 ACID 트랜잭션 보장
- 외부 시스템 연동 실패 시에도 주문 데이터 무결성 유지
- 재시도 메커니즘을 통한 외부 전송 재처리

### 3.4 확장성 (Scalability)
- 높은 트래픽 환경에서도 주문 처리 가능
- 외부 시스템 연동의 비동기 처리로 주문 처리 성능 영향 최소화

### 3.5 유지보수성 (Maintainability)
- 명확한 계층 분리 (Controller, Service, Repository 등)
- 트랜잭션 경계와 외부 연동 로직의 명확한 구분
- 주문 처리 흐름의 가독성 있는 구현

---

## 4. 비즈니스 규칙 및 제약사항

### 4.1 재고 관리 규칙
- **규칙 BR-01**: 옵션별 상품 재고는 음수가 될 수 없음
- **규칙 BR-02**: 주문 수량이 보유 재고를 초과할 수 없음 (옵션별 재고 기준)
- **규칙 BR-03**: 장바구니의 상품은 재고 차감 대상이 아님 (결제 시점에만 차감)
- **규칙 BR-04**: 재고 차감은 반드시 트랜잭션 내에서 수행되어야 함
- **규칙 BR-04-1**: 옵션을 가진 상품의 재고 차감은 **옵션 ID 기준**으로 수행되어야 함 (상품 총 재고 X)
- **규칙 BR-04-2**: 상품 총 재고 = 모든 옵션의 재고 합계 (일관성 검증 필요)

### 4.2 결제 및 잔액 관리 규칙
- **규칙 BR-05**: 결제금액이 사용자의 충전 잔액을 초과할 수 없음
- **규칙 BR-06**: 결제금액 계산: (상품 총액 - 쿠폰 할인액)
- **규칙 BR-07**: 결제 완료 후 사용자 잔액 = 기존 잔액 - 결제금액
- **규칙 BR-08**: 결제 실패 시 잔액은 변경되지 않음

### 4.3 쿠폰 관리 규칙
- **규칙 BR-09**: 쿠폰은 발급 가능 수량 범위 내에서만 발급 가능
- **규칙 BR-10**: 선착순 발급 쿠폰은 발급 수량 초과 시 발급 불가
- **규칙 BR-11**: 쿠폰은 유효기간 내에만 사용 가능
- **규칙 BR-12**: 쿠폰은 한 번만 사용 가능 (중복 사용 금지)
- **규칙 BR-13**: 쿠폰 사용 시 주문 ID와 사용 시간이 기록되어야 함

### 4.4 주문 처리 규칙
- **규칙 BR-14**: 주문은 장바구니 상품 정보로 생성
- **규칙 BR-15**: 주문 생성 시 모든 상품의 재고가 충분해야 함 (부분 주문 불가)
- **규칙 BR-16**: 주문 생성과 외부 시스템 전송은 분리되어야 함
- **규칙 BR-17**: 외부 시스템 전송 실패는 주문 상태에 영향을 주지 않음

### 4.5 외부 연동 규칙
- **규칙 BR-18**: 외부 시스템 전송이 실패한 데이터는 Outbox 테이블에 저장
- **규칙 BR-19**: 저장된 실패 데이터는 별도 배치 작업 또는 메시지 큐를 통해 재전송 시도
- **규칙 BR-20**: 외부 연동 실패가 주문 데이터의 기본 처리 완료를 막지 않음

---

## 5. 전체 주문 처리 흐름 요약

### 5.1 상세 주문 처리 플로우

#### 요구사항 5.1.1: 상품 선택
- **기능**: 사용자가 조회한 상품 정보를 기반으로 주문 대상 상품 선택
- **처리 내용**:
  - 상품명, 가격, 재고 수량, 상품 상태 조회 완료
  - 사용자가 주문하려는 상품과 수량 결정

#### 요구사항 5.1.2: 장바구니 관리
- **기능**: 선택한 상품을 장바구니에 저장
- **처리 내용**:
  - 상품 ID와 주문 수량을 장바구니에 저장
  - 장바구니 단계에서는 재고 차감 미수행
- **제약사항**: 장바구니는 재고에 영향을 주지 않음 (BR-03)

#### 요구사항 5.1.3: 결제 단계 - 재고 확인 (FRC-001)
- **기능**: 결제 시점에 각 상품의 현재 재고 실시간 확인
- **처리 순서**:
  1. 장바구니에 저장된 모든 상품 조회
  2. 각 상품의 현재 재고 수량 조회 (최신 데이터)
  3. 동시성 제어를 고려하여 재고 정보 조회 (Optimistic Lock)

#### 요구사항 5.1.4: 재고 충분성 검증 (FRC-002)
- **기능**: 각 상품별로 `재고 >= 주문 수량` 조건 검증
- **검증 조건**:
  - 모든 상품의 재고가 주문 수량 이상이어야 함
  - **조건 위반 시**: "재고 부족 알림" 오류 반환
  - 분기 처리: 조건 YES → 다음 단계(쿠폰 적용) 진행, NO → 재고 부족 알림 반환

#### 요구사항 5.1.5: 쿠폰 적용 (선택사항)
- **기능**: 사용자가 쿠폰을 사용하려는 경우 검증 및 적용
- **처리 내용**:
  - 쿠폰 유효성 검증 (2.3.2 요구사항 참고)
  - 쿠폰이 유효한 경우 할인액 확인
  - 쿠폰이 없거나 선택하지 않은 경우 할인액 = 0

#### 요구사항 5.1.6: 결제금액 계산 (FRC-003)
- **기능**: 최종 결제금액 산출
- **계산 공식**:
  ```
  결제금액 = 상품 총액 - 쿠폰 할인액
  ```
  - 상품 총액: ∑(상품 가격 × 수량)
  - 쿠폰 할인액: 적용된 쿠폰의 할인액 (없으면 0)
  - 결제금액이 음수가 되지 않도록 검증 (최소값 0)
- **비고**: 이 단계에서 최종 결제금액이 확정되어야 함

#### 요구사항 5.1.7: 잔액 검증 (FRC-004)
- **기능**: 사용자의 충전 잔액이 결제금액 이상인지 확인
- **검증 조건**: `balance >= 결제금액`
- **조건 위반 시**: "잔액 부족 알림" 오류 반환
- **분기 처리**: 조건 YES → 다음 단계(트랜잭션 시작) 진행, NO → 잔액 부족 알림 반환
- **제약사항**: 잔액 부족 시 재고나 다른 정보는 변경되지 않음 (BR-08)

#### 요구사항 5.1.8: 트랜잭션 시작 (TRANSACTION_START)
- **기능**: 주문 처리 트랜잭션 시작
- **목적**: 재고 차감, 주문 생성, 잔액 차감, 쿠폰 사용을 원자적으로 처리
- **트랜잭션 격리 수준**: READ_COMMITTED 이상 권장 (데이터 일관성 보장)
- **처리 원칙**: 이 지점부터는 모든 변경 작업이 하나의 단위로 처리되어야 함

#### 요구사항 5.1.9: 재고 차감 (FRC-005)
- **기능**: 각 상품의 재고 감소
- **처리 순서**:
  1. 각 상품별로 재고 차감 작업 수행
  2. 감소 공식: `재고 = 재고 - 주문 수량`
  3. 동시성 제어 적용 (Optimistic Lock)
  4. 재고가 음수가 되지 않도록 최종 검증
- **제약사항**:
  - 재고는 음수가 될 수 없음 (BR-01)
  - 트랜잭션 내에서 수행되어야 함 (BR-04)

#### 요구사항 5.1.10: 결제 처리 - 잔액 차감 (FRC-006)
- **기능**: 사용자의 충전 잔액에서 결제금액 차감
- **처리 순서**:
  1. 사용자 계정의 현재 잔액 조회
  2. 잔액 차감: `balance = balance - 결제금액`
  3. 차감 후 잔액이 음수가 되지 않도록 검증
- **제약사항**:
  - 결제 처리는 재고 차감 이후에 수행
  - 잔액 차감이 실패할 경우 트랜잭션 롤백

#### 요구사항 5.1.11: 주문 생성 (FRC-007)
- **기능**: 최종 주문 레코드 생성
- **주문 정보**:
  - 주문 ID (자동 생성)
  - 사용자 ID
  - 주문 상품 정보 (상품 ID, 수량, 가격)
  - 총 주문금액
  - 쿠폰 적용 여부 및 할인액
  - 결제금액
  - 주문 생성 시간
  - 주문 상태: "COMPLETED"
- **제약사항**: 주문 생성 시 모든 상품의 재고가 이미 차감되어야 함

#### 요구사항 5.1.12: 쿠폰 사용 이력 기록 (FRC-008)
- **기능**: 쿠폰을 사용한 경우, 사용 이력 기록 (선택사항)
- **처리 내용**:
  1. 쿠폰 상태를 `USED`로 변경
  2. 주문 ID와 쿠폰 사용 시간 기록
  3. 쿠폰의 유효성을 "이미 사용됨" 상태로 표시
- **비고**: 쿠폰을 사용하지 않은 경우 이 단계 스킵

#### 요구사항 5.1.13: 트랜잭션 종료 (TRANSACTION_COMMIT)
- **기능**: 모든 변경 사항을 데이터베이스에 커밋
- **처리 내용**:
  - 재고 차감, 잔액 차감, 주문 생성, 쿠폰 사용이 모두 성공한 경우만 커밋
  - 이전 단계에서 오류 발생 시 ROLLBACK 수행
- **결과**: 트랜잭션 완료 후 모든 변경이 영구적으로 데이터베이스에 저장됨

#### 요구사항 5.1.14: 주문 완료 반환 (FRC-009)
- **기능**: 클라이언트에게 주문 완료 정보 반환
- **반환 정보**:
  - 주문 ID
  - 주문 상태 (COMPLETED)
  - 최종 결제금액
  - 잔액 차감 완료 여부
  - 주문 생성 시간
- **응답 형식**: 성공 응답 (HTTP 200 또는 동등의 성공 상태 코드)

#### 요구사항 5.1.15: 외부 시스템 전송 (FRC-010)
- **기능**: 주문 데이터를 외부 시스템으로 전송
- **처리 원칙**:
  - 주문 처리 트랜잭션과 **완전히 분리**되어 별도 진행
  - 주문이 완료된 후 비동기로 실행
  - 외부 전송 실패는 주문 상태에 영향을 주지 않음 (BR-17)
- **처리 방식**: outbox 테이블 저장

---

### 5.2 주문 프로세스 (예외 처리)

#### 5.2.1 재고 부족 (ERR-001)
- **발생 조건**: 재고 >= 주문 수량 조건 미충족
- **처리 흐름**:
  ```
  결제 요청
    ├─ 재고 확인
    └─ [검증 실패] 재고 < 주문 수량
        └─ 주문 실패 응답 (Error Code: ERR-001)
  ```
- **상태 변경**: 없음 (재고 변경 X, 잔액 변경 X)
- **클라이언트 응답**:
  - 오류 메시지: "재고가 부족합니다. 현재 재고: {quantity}"
  - HTTP 상태: 400 Bad Request 또는 409 Conflict

#### 5.2.2 잔액 부족 (ERR-002)
- **발생 조건**: 결제금액 > 사용자 잔액
- **처리 흐름**:
  ```
  결제금액 계산 및 잔액 검증
    ├─ balance < 결제금액
    └─ [검증 실패] 잔액 부족
        └─ 주문 실패 응답 (Error Code: ERR-002)
  ```
- **상태 변경**: 없음 (재고 변경 X, 잔액 변경 X, 주문 미생성)
- **클라이언트 응답**:
  - 오류 메시지: "잔액이 부족합니다. 필요: {paymentAmount}, 현재: {balance}"
  - HTTP 상태: 402 Payment Required 또는 400 Bad Request

#### 5.2.3 쿠폰 무효 (ERR-003)
- **발생 조건**:
  - 쿠폰이 존재하지 않음
  - 쿠폰의 소유자가 현재 사용자가 아님
  - 쿠폰 유효기간 만료
  - 쿠폰이 이미 사용됨
- **처리 흐름**:
  ```
  쿠폰 유효성 검증
    ├─ 쿠폰 미존재 OR 소유 불일치 OR 유효기간 만료 OR 이미 사용됨
    └─ [검증 실패] 쿠폰 무효
        └─ 주문 실패 응답 (Error Code: ERR-003)
  ```
- **상태 변경**: 없음 (재고 변경 X, 잔액 변경 X, 주문 미생성)
- **클라이언트 응답**:
  - 오류 메시지: "유효하지 않은 쿠폰입니다." (상세 원인 포함)
  - HTTP 상태: 400 Bad Request

#### 5.2.4 트랜잭션 실패 (ERR-004)
- **발생 조건**: 트랜잭션 내 임의의 단계에서 오류 발생
  - 재고 차감 실패
  - 잔액 차감 실패
  - 주문 생성 실패
  - 데이터베이스 연결 오류
- **처리 흐름**:
  ```
  트랜잭션 진행 중
    ├─ [오류 발생] 재고 차감, 잔액 차감 등 중 하나 실패
    └─ 트랜잭션 ROLLBACK
        └─ 모든 변경사항 취소 (재고, 잔액 등)
  ```
- **상태 변경**: 없음 (모든 변경 사항 취소)
- **클라이언트 응답**:
  - 오류 메시지: "주문 처리 중 오류가 발생했습니다. 다시 시도해주세요."
  - HTTP 상태: 500 Internal Server Error

#### 5.2.5 외부 시스템 전송 실패 (ERR-005)
- **발생 조건**: 배송 시스템 또는 회계 시스템 API 호출 실패
- **처리 흐름**:
  ```
  주문 완료 상태
    ├─ 외부 시스템 전송 시도
    └─ [전송 실패] 배송/회계 시스템 응답 없음 또는 오류
        ├─ 실패 데이터를 Outbox 테이블에 저장
        ├─ 주문 상태: 변경 없음 (여전히 COMPLETED)
        └─ 배치/큐 작업에서 재시도 예약
  ```
- **상태 변경**: 주문 상태는 COMPLETED 유지 (외부 전송 분리)
- **재시도 메커니즘**:
  - Outbox 패턴 적용
  - 별도 배치 작업 또는 메시지 큐에서 주기적 재시도
  - 재시도 횟수 제한 및 최대 시간 설정
- **비고**: 외부 전송 실패는 고객의 주문 완료 상태에 영향을 주지 않음 (BR-20)


### 5.3 쿠폰 발급 프로세스

```
1. 쿠폰 발급 요청
   └─ 남은 발급 가능 수량 > 0 확인

2. 원자적 수량 감소 (동시성 제어)
   └─ 발급 가능 수량 -= 1

3. 쿠폰 생성
   ├─ 사용자 ID와 쿠폰 ID 매핑
   ├─ 발급 일시 기록
   └─ 상태: ISSUED

4. 사용자에게 쿠폰 ID 반환
```

### 5.4 인기 상품 조회 프로세스

```
1. 인기 상품 조회 요청
   └─ 최근 3일간 기준 설정

2. 데이터 집계
   ├─ 지난 3일간의 주문/판매/조회 데이터 수집
   └─ 상품별 집계 (주문량, 판매량, 조회 수 등)

3. 정렬 및 상위 5개 추출
   ├─ 집계 데이터 기준으로 내림차순 정렬
   └─ 상위 5개만 조회 결과로 반환

4. 상품 정보 포함
   ├─ 상품명, 가격, 현재 재고, 상태
   └─ 집계 데이터 (주문량, 판매량 등) 포함
```

---

## 6. 주요 설계 고려사항

### 6.1 동시성 제어 (Concurrency Control)
- **재고 차감**: Optimistic Lock을 활용한 Race Condition 방지
- **쿠폰 발급**: 데이터베이스 레벨에서 원자적 감소 (예: `UPDATE ... SET count = count - 1 WHERE id = ? AND count > 0`)

### 6.2 트랜잭션 설계
- **주문 처리**: 재고 차감, 주문 생성, 잔액 차감, 쿠폰 사용을 하나의 트랜잭션으로 묶어 원자성 보장
- **외부 전송**: 별도 트랜잭션으로 처리하여 주문 처리와 분리

### 6.3 외부 연동 패턴 (Outbox Pattern)
- 주문 생성 트랜잭션 내에서 Outbox 테이블에 전송 대상 데이터 기록
- 별도 배치 또는 메시지 큐를 통해 Outbox 데이터를 외부 시스템으로 전송
- 전송 완료 후 Outbox 레코드 삭제

### 6.4 결제금액 계산의 명확성
- 쿠폰 할인은 결제 시점에만 적용
- 계산식 명시: `결제금액 = 상품 총액 - 쿠폰 할인액`
- 할인 후 결제금액이 음수가 되지 않도록 검증

### 6.5 장바구니와 재고의 분리
- 장바구니 추가/변경 시 재고 차감 금지
- 재고 차감은 결제(주문 생성) 시점에만 수행
- 이를 통해 사용자 경험 개선 (주문 전까지 장바구니 자유 수정)

### 6.6 상품 옵션 기반 재고 관리 (Product Option-based Inventory Management)
- **옵션별 독립적 재고 관리**:
  - 각 옵션은 고유한 재고 수량을 유지
  - 상품 총 재고 = ∑(모든 옵션의 재고)
  - 재고 차감 시 옵션 ID를 기반으로만 차감 수행

- **장바구니 구조 개선**:
  - 상품 ID + **옵션 ID** + 수량
  - 같은 상품의 다른 옵션은 별도 아이템으로 취급

- **주문 정보 기록**:
  - 주문 생성 시 옵션 ID 반드시 포함
  - 외부 시스템 전송 시에도 옵션 정보 전달 필수

- **데이터 일관성 보장**:
  - 옵션별 재고가 음수가 되지 않도록 검증
  - 상품 총 재고와 옵션 재고 합계가 일치하는지 주기적 검증
  - 옵션 추가/삭제 시 상품 상태("판매 중"/"품절") 자동 업데이트

- **오류 처리 정확성**:
  - 재고 부족 오류 메시지에 부족한 옵션명 명시
  - 예: "블랙 / M의 재고가 부족합니다. 현재 재고: 2개, 요청 수량: 5개"
